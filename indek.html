<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPP SMP Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Style untuk Sidebar di Desktop */
        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            width: 256px; /* md:w-64 */
        }
        /* Style untuk Main Content di Desktop */
        #main-content {
            transition: margin-left 0.3s ease-in-out;
            margin-left: 256px; /* md:ml-64 */
        }
        /* Overlay hanya untuk mobile */
        #mobile-overlay {
            transition: opacity 0.3s ease-in-out;
            z-index: 40;
        }
        .sidebar-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .sidebar-submenu.active {
            max-height: 500px; /* Cukup besar untuk menampung sub-menu */
        }
        
        /* Bar Chart Styling */
        .bar-container {
            height: 150px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }
        .bar {
            width: 100%;
            transition: height 0.5s ease-out;
            position: relative;
            background-color: #4f46e5; /* indigo-600 */
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            cursor: pointer;
        }
        .bar-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #1f2937; /* gray-800 */
            font-weight: 600;
            white-space: nowrap;
        }
        .bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .bar:hover .bar-tooltip {
            opacity: 1;
        }
        .bar-bar-wrapper {
             /* Wrapper for bar and label below */
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
        }
        .bar-bottom-label {
            margin-top: 4px;
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header (Fixed Top Bar) -->
    <header id="header" class="fixed top-0 left-0 right-0 z-20 bg-white shadow-md transition-all duration-300 md:pl-64 h-16">
        <div class="flex items-center justify-between h-full px-4 md:px-6">
            <!-- Tombol Toggle Sidebar (Hanya di mobile/tablet) -->
            <button id="sidebar-toggle-btn" class="p-2 mr-4 text-gray-600 rounded-full hover:bg-gray-100 md:hidden" aria-label="Toggle Menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
            
            <!-- Current Page Title (Dynamic) -->
            <div id="page-title-display" class="hidden md:flex items-center text-xl font-bold text-gray-800">
                <!-- Judul menu aktif diisi oleh JavaScript -->
            </div>

            <div class="flex items-center space-x-4">
                <!-- Info Sekolah & Waktu -->
                <div class="flex flex-col items-end text-right">
                    <!-- Waktu Aktif -->
                    <div id="current-time-container" class="sm:block text-right">
                        <div id="current-time" class="text-sm font-bold text-gray-800 leading-none"></div>
                        <div id="current-date" class="text-xs text-gray-500 leading-none mt-0.5"></div>
                    </div>
                    <!-- Nama Sekolah (BARU: Dipindahkan ke bawah tanggal) -->
                    <div id="school-name-display" class="hidden sm:block text-xs font-semibold text-gray-700 leading-tight mt-1">
                        Loading School Name...
                    </div>
                </div>
                
                <!-- User ID -->
                <div id="user-info" class="bg-indigo-100 text-indigo-700 text-xs font-semibold px-3 py-1.5 rounded-full truncate max-w-[150px] md:max-w-none">
                    Loading User...
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 transform -translate-x-full md:translate-x-0 bg-gray-800 text-white shadow-xl flex flex-col">
        <!-- Main App Title/Branding moved here -->
        <div class="flex items-center justify-center h-16 px-4 bg-indigo-700 flex-shrink-0 shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-white"><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8l-4 2"/><path d="m2 12 4-2"/><path d="M6 10v9"/><path d="M18 10v9"/><path d="M22 12v9"/><path d="M2 17v3"/><path d="M12 2v9"/><path d="M12 17v5"/></svg>
            <span class="text-xl font-bold font-inter">SPP<span class="text-green-300">.ID</span></span>
        </div>

        <!-- Scrollable Menu Content -->
        <div id="sidebar-menu-wrapper" class="flex-1 p-4 space-y-2 overflow-y-auto">
            
            <!-- Menu Dashboard (Selalu Terpisah) -->
            <button data-path="dashboard" class="menu-item flex items-center w-full px-4 py-2 rounded-lg transition-colors duration-200 bg-indigo-600 text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
                <span>Dashboard Utama</span>
            </button>
            
            <!-- Navigasi Baru Berdasarkan Kategori -->
            <nav id="sidebar-nav" class="space-y-1 mt-4">
                <!-- Konten akan diisi oleh renderSidebar() -->
            </nav>

        </div>
        <div class="p-4 border-t border-gray-700 text-sm text-gray-400">
            <p class="font-semibold">Info Login:</p>
            <p id="full-user-id" class="text-xs break-all"></p>
        </div>
    </aside>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black opacity-0 hidden md:hidden"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 pt-16 pb-12 p-4 md:p-8">
        <div id="app-container" class="max-w-7xl mx-auto">
            <!-- Content will be rendered here -->
            <div id="loading-spinner" class="text-center p-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 inline-block"></div>
                <p class="mt-4 text-gray-600">Memuat data dan autentikasi...</p>
            </div>
        </div>
    </main>

    <!-- Footer (Fixed Bottom) -->
    <footer id="footer" class="fixed bottom-0 left-0 right-0 z-10 bg-white border-t border-gray-200 text-center text-sm text-gray-600 p-3 transition-all duration-300 md:pl-64">
        <p>copyrightÂ© 2025 Deni Ahmad. All Rights Reserved.</p>
    </footer>

    <!-- Modal for Custom Alerts/Confirmations (Using Tailwind classes) -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">Pesan</h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            
            <!-- BARU: Password input field untuk konfirmasi delete -->
            <div id="modal-password-container" class="mb-4 hidden">
                <label for="modal-password-input" class="block text-sm font-medium text-gray-700 mb-1">Masukkan Password Konfirmasi:</label>
                <input type="password" id="modal-password-input" class="w-full px-3 py-2 border border-red-400 rounded-lg focus:ring-red-500 focus:border-red-500">
            </div>
            <!-- END BARU -->

            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="hidden px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Batal</button>
                <button id="modal-ok-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, 
            serverTimestamp, setDoc, query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // setLogLevel('Debug'); // Untuk debugging

        // --- KONSTANTA & KONFIGURASI Awal (Akan ditimpa oleh Firebase Config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDfyNz-WkveqCI1FjPuf4boIEK8QC90eXY",
            authDomain: "spp-smp-lieur.firebaseapp.com",
            projectId: "spp-smp-lieur",
            storageBucket: "spp-smp-lieur.firebasestorage.app",
            messagingSenderId: "1011946507271",
            appId: "1:1011946507271:web:97b449f45b28b33579eea2",
            measurementId: "G-PEK2EFSZTL"
        };
        
        let SPP_PER_MONTH = 150000; // Default awal, akan ditimpa
        let DSP_BASE_AMOUNT = 1500000; // Default awal, akan ditimpa
        const MAX_MONTHS = 12;
        const INITIAL_SCHOOL_CASH = 10000000;

        // BARU: Password untuk konfirmasi delete
        const DELETE_PASSWORD = 'deniahmad88'; 

        const MENU_CATEGORIES = [
            { 
                name: 'Transaksi Keuangan', 
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v2"/><path d="M21 6v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M12 12h3"/><path d="M15 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>`, 
                items: [
                    { name: 'Transaksi Siswa', path: 'pembayaran' },
                    { name: 'Transaksi Sekolah', path: 'transaksi_sekolah' },
                ]
            },
            { 
                name: 'Data Master', 
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="7" r="4"/><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`, 
                items: [
                    { name: 'Data Siswa', path: 'siswa' },
                    { name: 'Siswa RMP (Potongan SPP)', path: 'siswa_rmp' }, // Diubah dari Data Kelas
                ]
            },
            { 
                name: 'Laporan & Administrasi', 
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`, 
                items: [
                    { name: 'Tunggakan Siswa', path: 'laporan' },
                    { name: 'Riwayat Transaksi', path: 'riwayat_admin' },
                    { name: 'Laporan Keuangan', path: 'laporan_keuangan' }, // BARU: Laporan Keuangan
                ]
            },
            { 
                name: 'Pengaturan', 
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-.77 1.57l-.27.24a2 2 0 0 0-.58 2.05L7.75 11.23a2 2 0 0 0 1.05 1.5l.29.17a2 2 0 0 1 1.76 0l.29-.17a2 2 0 0 0 1.05-1.5l-.26-1.93a2 2 0 0 0-.58-2.05l-.27-.24a2 2 0 0 1-.77-1.57V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/><path d="M16.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-.77 1.57l-.27.24a2 2 0 0 0-.58 2.05L7.75 11.23a2 2 0 0 0 1.05 1.5l.29.17a2 2 0 0 1 1.76 0l.29-.17a2 2 0 0 0 1.05-1.5l-.26-1.93a2 2 0 0 0-.58-2.05l-.27-.24a2 2 0 0 1-.77-1.57V4a2 2 0 0 0-2-2z" transform="rotate(60 12 12)"/></svg>`, 
                items: [
                    { name: 'Pengaturan Umum', path: 'pengaturan_app' }, // Diubah
                ]
            },
        ];

        // Daftar semua kelas yang mungkin (diambil dari data Siswa)
        const ALL_GRADES = ['7A', '7B', '7C', '8A', '8B', '8C', '9A', '9B', '9C'];
        const MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        // Urutan bulan dalam satu tahun ajaran (Juli ke Juni)
        const ACADEMIC_MONTH_NAMES = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni']; 


        // --- GLOBAL STATE ---
        let db, auth;
        let userId = null;
        let activeMenu = 'dashboard';
        let studentsData = [];
        let transactionsData = []; // Transaksi Siswa (SPP/Non-SPP/DSP)
        let cashTransactionsData = []; // Transaksi Kas Sekolah (Pemasukan/Pengeluaran)
        let rmpStudentsData = []; // Data siswa RMP (hanya ID dan Diskon)
        let appConfig = { // State baru untuk konfigurasi aplikasi
            general: {
                schoolName: "SMP Negeri Gaya Bersih",
                year: "2024/2025",
                address: "Jl. Bersih No. 1, Kota Lieur",
                phone: "021-1234567"
            },
            payment: {
                spp: {}, // SPP per kelas
                dsp: DSP_BASE_AMOUNT
            }
        }; 
        let summaryData = { totalStudents: 0, totalPaid: 0, totalDue: 0, schoolCash: INITIAL_SCHOOL_CASH }; 
        let isSidebarOpen = false;
        let isAuthAttempted = false; // Flag baru untuk mengontrol upaya sign-in
        let currentPaymentTypeState = 'cards'; // State untuk sub-menu Transaksi Siswa
        let currentSchoolTxState = 'cards'; // State baru untuk sub-menu Transaksi Sekolah
        let rmpDiscountRate = 50; // Default diskon 50%

        // --- UTILITIES ---

        const currencyFormatter = new Intl.NumberFormat('id-ID', { 
            style: 'currency', currency: 'IDR', minimumFractionDigits: 0 
        });
        const timeFormatter = new Intl.DateTimeFormat('id-ID', { 
            hour: '2-digit', minute: '2-digit', second: '2-digit' 
        });
        const dayDateFormatter = new Intl.DateTimeFormat('id-ID', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        function formatCurrency(amount) {
            return currencyFormatter.format(amount);
        }

        function getCollectionPath(collectionName) {
            if (!db || !userId) return null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Menggunakan jalur 7 segmen yang benar: C/D/C/D/C/D/C
            // Path: artifacts/{appId}/users/{userId}/spp_system_data/data/{collectionName}
            return collection(db, `artifacts/${appId}/users/${userId}/spp_system_data/data/${collectionName}`);
        }
        
        function getDocPath(collectionName, docId) {
            if (!db || !userId) return null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Path: artifacts/{appId}/users/{userId}/spp_system_data/data/{collectionName}/{docId}
            return doc(db, `artifacts/${appId}/users/${userId}/spp_system_data/data/${collectionName}`, docId);
        }


        /**
         * Custom Modal (Pengganti alert/confirm)
         * @param {string} message 
         * @param {boolean} isConfirmation 
         * @param {string} title 
         * @param {boolean} isPasswordProtected BARU: Flag untuk meminta password
         * @returns {Promise<boolean>}
         */
        function showModal(message, isConfirmation = false, title = "Pesan", isPasswordProtected = false) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const okBtn = document.getElementById('modal-ok-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                
                // Elemen Password
                const passwordContainer = document.getElementById('modal-password-container');
                const passwordInput = document.getElementById('modal-password-input');
                passwordInput.value = ''; // Reset password
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                if (isPasswordProtected) {
                    passwordContainer.classList.remove('hidden');
                    okBtn.textContent = "Konfirmasi Hapus";
                    cancelBtn.classList.remove('hidden');
                } else {
                    passwordContainer.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                    okBtn.textContent = isConfirmation ? "Ya, Lanjutkan" : "OK";
                }
                
                // Handler saat OK diklik
                okBtn.onclick = () => {
                    if (isPasswordProtected && passwordInput.value !== DELETE_PASSWORD) {
                        messageEl.textContent = "Password salah. Coba lagi.";
                        passwordInput.value = '';
                        passwordInput.focus();
                        return;
                    }
                    
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    resolve(true);
                };

                // Handler saat Batal diklik
                cancelBtn.onclick = () => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    resolve(false);
                };

                if (isPasswordProtected) {
                     passwordInput.focus();
                } else {
                     okBtn.focus();
                }
            });
        }
        
        /**
         * Fungsi untuk menghapus dokumen transaksi dengan konfirmasi password
         * @param {string} docId ID dokumen transaksi di Firestore
         * @param {string} collectionName Nama koleksi ('transactions' atau 'school_cash_transactions')
         */
        async function handleTransactionDelete(docId, collectionName) {
            const confirmation = await showModal(
                `Apakah Anda yakin ingin menghapus transaksi ini secara permanen? Tindakan ini tidak dapat dibatalkan.`, 
                true, 
                "KONFIRMASI HAPUS TRANSAKSI",
                true // Meminta password
            );

            if (!confirmation) return;

            const txRef = getCollectionPath(collectionName);
            if (!txRef) return showModal("Sistem Firebase belum siap.");

            try {
                await deleteDoc(doc(txRef, docId));
                showModal("Transaksi berhasil dihapus!", false, "Sukses");
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showModal("Gagal menghapus transaksi: " + error.message, false, "Error");
            }
        }

        // --- UI & TATA LETAK ---

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            isSidebarOpen = !isSidebarOpen;

            if (isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden', 'opacity-0');
                overlay.classList.add('opacity-50');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('opacity-50');
                overlay.classList.add('opacity-0', 'hidden');
            }
        }

        function setupEventListeners() {
            document.getElementById('sidebar-toggle-btn').addEventListener('click', toggleSidebar);
            document.getElementById('mobile-overlay').addEventListener('click', toggleSidebar);
            // FIX: Mengganti listener dari 'sidebar-nav' ke container terluar (sidebar-menu-wrapper)
            document.getElementById('sidebar-menu-wrapper').addEventListener('click', handleSidebarClick);
            
            // BARU: Listener Global untuk Tombol Hapus Transaksi
            document.getElementById('main-content').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-tx-btn');
                if (deleteBtn) {
                    const docId = deleteBtn.getAttribute('data-doc-id');
                    const collectionName = deleteBtn.getAttribute('data-collection');
                    if (docId && collectionName) {
                        handleTransactionDelete(docId, collectionName);
                    }
                }
            });
        }

        function handleSidebarClick(e) {
            const target = e.target.closest('.menu-item') || e.target.closest('.submenu-toggle');

            if (!target) return;

            if (target.classList.contains('submenu-toggle')) {
                // Toggle Accordion
                const submenu = target.nextElementSibling;
                submenu.classList.toggle('active');
                
                // Rotate Arrow
                const arrow = target.querySelector('.menu-arrow');
                if (submenu.classList.contains('active')) {
                    arrow.classList.add('rotate-90');
                } else {
                    arrow.classList.remove('rotate-90');
                }
            } else if (target.classList.contains('menu-item')) {
                // Pindah Halaman
                const path = target.getAttribute('data-path');
                if (path) {
                    setActiveMenu(path);
                    if (window.innerWidth < 768) { // Tutup di mobile
                        toggleSidebar();
                    }
                }
            }
        }

        function renderSidebar() {
            const navContainer = document.getElementById('sidebar-nav');
            let html = '';

            MENU_CATEGORIES.forEach(category => {
                // Periksa apakah ada item yang aktif di kategori ini
                const isCategoryActive = category.items.some(item => item.path === activeMenu);
                
                html += `
                    <div>
                        <!-- Tombol Toggle Kategori (Accordion) -->
                        <button class="submenu-toggle flex items-center justify-between w-full px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg font-semibold transition-colors duration-200">
                            <span class="flex items-center">
                                ${category.icon}
                                <span class="ml-3 text-sm">${category.name}</span>
                            </span>
                            <svg class="w-4 h-4 menu-arrow transform transition-transform duration-300 ${isCategoryActive ? 'rotate-90' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                        
                        <!-- Submenu -->
                        <div class="sidebar-submenu pl-6 ${isCategoryActive ? 'active' : ''}">
                            ${category.items.map(item => `
                                <button data-path="${item.path}" class="menu-item flex items-center w-full px-3 py-1.5 rounded-lg transition-colors duration-200 text-sm ${
                                    activeMenu === item.path
                                        ? 'bg-indigo-600 text-white shadow-lg'
                                        : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                }">
                                    <span>${item.name}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            navContainer.innerHTML = html;
        }

        function resetPaymentState() {
            currentPaymentTypeState = 'cards';
        }

        function resetSchoolTxState() {
            currentSchoolTxState = 'cards';
        }
        
        // --- LOGIKA JUDUL DINAMIS ---
        function getMenuTitle(path) {
            if (path === 'dashboard') return 'Dashboard Utama';

            // Cari di dalam kategori utama (path: siswa, laporan, etc.)
            for (const category of MENU_CATEGORIES) {
                for (const item of category.items) {
                    if (item.path === path) {
                        return `${item.name}`;
                    }
                }
            }
            
            // Untuk halaman placeholder dan sub-menu transaksi
            const titleMap = {
                'spp': 'Pembayaran SPP Bulanan',
                'non_spp': 'Pembayaran Non SPP',
                'dsp': 'Pembayaran DSP',
                'transaksi_sekolah': 'Transaksi Sekolah (Kas & Pengeluaran)',
                'input_pemasukan': 'Input Pemasukan Sekolah',
                'input_pengeluaran': 'Input Pengeluaran Sekolah',
                'kelas_master': 'Data Master Kelas',
                'riwayat_admin': 'Riwayat Transaksi',
                'siswa_rmp': 'Data Siswa RMP (Potongan SPP)',
                'pengaturan_app': 'Pengaturan Umum & Pembayaran', // Diubah
                'laporan_keuangan': 'Laporan Keuangan', // BARU
                'cards': 'Transaksi Siswa', // Fallback for the main page
            };
            return titleMap[path] || 'Halaman';
        }

        function updatePageTitle(path) {
            const titleEl = document.getElementById('page-title-display');
            if (titleEl) {
                const title = getMenuTitle(path);
                titleEl.textContent = title;
            }
        }

        function setActiveMenu(path) {
            // Reset state spesifik halaman saat berpindah
            if (activeMenu === 'pembayaran' && path !== 'pembayaran') {
                resetPaymentState();
            }
             if (activeMenu === 'transaksi_sekolah' && path !== 'transaksi_sekolah') {
                resetSchoolTxState();
            }
            activeMenu = path;
            // Update tampilan sidebar setelah menu aktif berubah
            renderSidebar(); 
            // updatePageTitle() akan dipanggil di renderContent
            renderContent();
        }

        function updateClock() {
            const now = new Date();
            const schoolNameEl = document.getElementById('school-name-display');

            // Waktu (HH:mm:ss)
            document.getElementById('current-time').textContent = timeFormatter.format(now);
            // Hari, Tanggal, Bulan, Tahun
            document.getElementById('current-date').textContent = dayDateFormatter.format(now);
            
            // Update Nama Sekolah
            if (schoolNameEl) {
                schoolNameEl.textContent = appConfig.general.schoolName || 'Nama Sekolah';
            }
        }

        // --- FIREBASE & DATA LOGIC ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Setup the state listener (Hanya untuk bereaksi setelah sign-in selesai)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `User ID: ${userId.substring(0, 8)}...`;
                        document.getElementById('full-user-id').textContent = `ID Lengkap: ${userId}`;
                        startDataListeners();
                        document.getElementById('loading-spinner').classList.add('hidden');
                        renderSidebar(); // Render sidebar setelah auth
                        renderContent();
                    } else if (isAuthAttempted) {
                        // Ini akan terjadi jika onAuthStateChanged dipicu dengan null setelah upaya sign-in,
                        // yang mungkin berarti sign-in anonim pun gagal, atau pengguna secara eksplisit logout.
                        console.log("onAuthStateChanged fired with null after sign-in attempt.");
                    }
                });

                // 2. Attempt Sign-in Immediately (Gunakan token atau fallback anonim)
                if (!isAuthAttempted) {
                    isAuthAttempted = true;
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (tokenError) {
                        // Menangani Firebase Auth Error (auth/custom-token-mismatch) secara internal
                        console.warn("Custom token sign-in failed (e.g., mismatch). Attempting anonymous sign-in:", tokenError.code);
                        
                        // Fallback Krusial: Jika token kustom gagal, langsung coba sign-in anonim
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Fallback Anonymous Sign-in Failed:", anonError);
                            // Jika anonim pun gagal, set ID lokal sebagai last resort
                            userId = crypto.randomUUID();
                            document.getElementById('user-info').textContent = `Fallback ID: ${userId.substring(0, 8)}...`;
                            document.getElementById('full-user-id').textContent = `ID Lengkap: ${userId}`;
                            document.getElementById('loading-spinner').classList.add('hidden');
                            renderSidebar(); // Render sidebar tanpa data, hanya struktur
                            renderContent();
                        }
                    }
                }

            } catch (e) {
                console.error("Error initializing Firebase:", e);
                document.getElementById('loading-spinner').innerHTML = `<p class="text-red-600">Gagal inisialisasi Firebase. Cek konsol untuk detail.</p>`;
            }
        }
        
        /**
         * Mendapatkan daftar 12 bulan (Bulan & Tahun) yang wajib dibayar dalam tahun ajaran saat ini.
         * Mulai dari Juli (tahun awal) sampai Juni (tahun akhir).
         * @returns {Array<{month: string, year: number}>}
         */
        function getAcademicMonths() {
            const yearString = appConfig.general.year || "2024/2025";
            const [startYearStr, endYearStr] = yearString.split('/');
            
            // Parse years
            const startYear = parseInt(startYearStr);
            const endYear = parseInt(endYearStr);
            
            // Safety check for year format
            if (isNaN(startYear) || isNaN(endYear) || endYear !== startYear + 1) {
                // Fallback: Menggunakan tahun saat ini + 1 sebagai tahun ajaran default
                const currentYear = new Date().getFullYear();
                // Tentukan tahun awal untuk Juli-Des: jika sekarang Juli/lebih, tahun ini; jika Jan-Juni, tahun lalu.
                const fallbackStartYear = MONTHS.indexOf('Juli') >= new Date().getMonth() ? currentYear - 1 : currentYear;
                const fallbackEndYear = fallbackStartYear + 1;
                
                const fallbackMonths = [];
                for (let i = 0; i < 12; i++) {
                     const monthName = ACADEMIC_MONTH_NAMES[i];
                     // Juli-Des (index 0-5) = tahun awal; Jan-Jun (index 6-11) = tahun akhir
                     const year = i < 6 ? fallbackStartYear : fallbackEndYear; 
                     fallbackMonths.push({ month: monthName, year: year }); 
                }
                return fallbackMonths;
            }

            const academicMonths = [];
            for (let i = 0; i < 12; i++) {
                const monthName = ACADEMIC_MONTH_NAMES[i];
                const year = i < 6 ? startYear : endYear; // Juli-Des = tahun awal, Jan-Jun = tahun akhir
                academicMonths.push({ month: monthName, year: year });
            }
            return academicMonths;
        }

        /**
         * Menghitung nilai SPP per bulan untuk siswa tertentu,
         * menerapkan diskon jika siswa terdaftar sebagai RMP.
         * @param {string} studentId 
         * @param {string} grade Kelas Siswa (untuk cek SPP per kelas)
         * @returns {number} Biaya SPP per bulan setelah diskon.
         */
        function getStudentSPP(studentId, grade = null) {
            // 1. Ambil SPP dasar dari konfigurasi per kelas
            const baseSpp = (grade && appConfig.payment.spp[grade]) ? appConfig.payment.spp[grade] : SPP_PER_MONTH; 

            // 2. Cek apakah siswa termasuk RMP
            const isRMP = rmpStudentsData.some(rmp => rmp.studentId === studentId);

            if (isRMP) {
                const discount = rmpDiscountRate / 100;
                return baseSpp * (1 - discount);
            }
            return baseSpp;
        }
        
         /**
         * Menghitung nilai DSP untuk siswa tertentu,
         * menerapkan diskon jika siswa terdaftar sebagai RMP.
         * @param {string} studentId 
         * @returns {number} Biaya DSP setelah diskon.
         */
        function getStudentDSP(studentId) {
            // 1. Ambil DSP dasar dari konfigurasi
            const baseDSP = appConfig.payment.dsp || DSP_BASE_AMOUNT;
            
            // 2. Cek apakah siswa termasuk RMP
            const isRMP = rmpStudentsData.some(rmp => rmp.studentId === studentId);

            if (isRMP) {
                const discount = rmpDiscountRate / 100;
                return baseDSP * (1 - discount);
            }
            return baseDSP;
        }


        function calculateSummary(students, transactions, cashTransactions) {
            let totalPaidSPP = 0;
            let totalDueSPP = 0;
            let totalDueDSP = 0; // BARU: Tunggakan DSP
            let totalIncomeNonSPP = 0;
            let totalExpense = 0;

            // 1. Hitung SPP Siswa (Total Dibayar dan Tunggakan)
            students.forEach(student => {
                const paidSPPAmount = transactions
                    .filter(t => t.studentId === student.id && t.monthPaid) // Hanya hitung SPP
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                // Hitung DSP yang sudah dibayar
                const paidDSPAmount = transactions
                    .filter(t => t.studentId === student.id && t.type === 'DSP') 
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const studentMonthlySPP = getStudentSPP(student.id, student.grade);
                const requiredSPP = studentMonthlySPP * MAX_MONTHS;
                const requiredDSP = getStudentDSP(student.id);

                totalPaidSPP += paidSPPAmount;
                totalDueSPP += Math.max(0, requiredSPP - paidSPPAmount);
                
                // Hitung Tunggakan DSP
                totalDueDSP += Math.max(0, requiredDSP - paidDSPAmount);
            });
            
            // 2. Hitung Transaksi Kas Sekolah
            cashTransactions.forEach(t => {
                if (t.type === 'INCOME') {
                    totalIncomeNonSPP += t.amount;
                } else if (t.type === 'EXPENSE') {
                    totalExpense += t.amount;
                }
            });

            // 3. Hitung Saldo Kas Riil
            const totalPemasukan = totalPaidSPP + totalIncomeNonSPP;
            const schoolCash = INITIAL_SCHOOL_CASH + totalPemasukan + transactions.filter(t => t.type === 'DSP' || t.type === 'NON_SPP').reduce((sum, t) => sum + t.amount, 0) - totalExpense;


            summaryData = {
                totalStudents: students.length,
                totalPaid: totalPaidSPP,
                totalDue: totalDueSPP + totalDueDSP, // TOTAL Tunggakan = SPP + DSP
                schoolCash: schoolCash
            };
        }

        function startDataListeners() {
            const studentsRef = getCollectionPath('students');
            const transactionsRef = getCollectionPath('transactions');
            const cashTransactionsRef = getCollectionPath('school_cash_transactions');
            const rmpRef = getCollectionPath('rmp_students');
            const configDocRef = getDocPath('app_config', 'settings'); // Referensi konfigurasi app

            if (!studentsRef || !transactionsRef || !cashTransactionsRef || !rmpRef || !configDocRef) {
                console.error("Firestore references are not ready.");
                return;
            }
            
            // Listener Konfigurasi Aplikasi (BARU)
            onSnapshot(configDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    // Update state appConfig
                    appConfig.general = data.general || appConfig.general;
                    appConfig.payment.spp = data.payment?.spp || ALL_GRADES.reduce((acc, grade) => ({ ...acc, [grade]: SPP_PER_MONTH }), {}); // Default SPP jika kosong
                    appConfig.payment.dsp = data.payment?.dsp || DSP_BASE_AMOUNT;
                    
                    // Update konstanta global (biar lebih clean)
                    DSP_BASE_AMOUNT = appConfig.payment.dsp;
                    SPP_PER_MONTH = appConfig.payment.spp['9A'] || 150000; // Ambil salah satu nilai SPP untuk default tampilan

                } else {
                    // Jika dokumen tidak ada, inisialisasi SPP per kelas
                    appConfig.payment.spp = ALL_GRADES.reduce((acc, grade) => ({ ...acc, [grade]: SPP_PER_MONTH }), {});
                }
                // Paksa re-render semua yang tergantung pada config
                calculateSummary(studentsData, transactionsData, cashTransactionsData);
                updateClock(); // Update nama sekolah di header
                renderContent();
            }, (error) => {
                console.error("Error fetching app config:", error);
            });


            // Listener Siswa
            onSnapshot(studentsRef, (snapshot) => {
                studentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calculateSummary(studentsData, transactionsData, cashTransactionsData);
                renderContent();
            }, (error) => {
                console.error("Error fetching students:", error);
            });

            // Listener Transaksi Siswa
            onSnapshot(transactionsRef, (snapshot) => {
                transactionsData = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date()
                }));
                calculateSummary(studentsData, transactionsData, cashTransactionsData);
                renderContent();
            }, (error) => {
                console.error("Error fetching student transactions:", error);
            });
            
            // Listener Transaksi Kas Sekolah
            onSnapshot(cashTransactionsRef, (snapshot) => {
                cashTransactionsData = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date()
                }));
                calculateSummary(studentsData, transactionsData, cashTransactionsData);
                renderContent();
            }, (error) => {
                console.error("Error fetching cash transactions:", error);
            });
            
            // Listener Siswa RMP 
            onSnapshot(rmpRef, (snapshot) => {
                rmpStudentsData = snapshot.docs.map(doc => ({ 
                    docId: doc.id, // ID dokumen Firestore (penting untuk hapus)
                    ...doc.data()
                }));
                // Ambil rata-rata atau nilai default diskon dari konfigurasi
                const configDoc = rmpStudentsData.find(d => d.docId === 'discount_config');
                if (configDoc && typeof configDoc.discountRate === 'number') {
                    rmpDiscountRate = configDoc.discountRate;
                }

                calculateSummary(studentsData, transactionsData, cashTransactionsData);
                renderContent();
            }, (error) => {
                console.error("Error fetching RMP students:", error);
            });

             // Inisialisasi data dummy jika tidak ada siswa (hanya sekali)
            if (studentsData.length === 0) {
                setTimeout(seedInitialData, 3000); 
            }
        }

        async function seedInitialData() {
            if (studentsData.length > 0) return; 
            const studentsRef = getCollectionPath('students');
            const configDocRef = getDocPath('app_config', 'settings');
            if (!studentsRef || !configDocRef) return;

            const dummyStudents = [
                { nis: '001', name: 'Budi Santoso', grade: '9A', sppPerMonth: SPP_PER_MONTH },
                { nis: '002', name: 'Siti Aminah', grade: '8B', sppPerMonth: SPP_PER_MONTH },
                { nis: '003', name: 'Joko Susilo', grade: '7C', sppPerMonth: SPP_PER_MONTH },
            ];

            // Tambahkan Siswa Dummy
            for (const student of dummyStudents) {
                try {
                    const docRef = await addDoc(studentsRef, student);
                    console.log("Siswa dummy ditambahkan dengan ID: ", docRef.id);
                } catch (e) {
                    console.error("Error menambahkan siswa dummy: ", e);
                }
            }
            
            // Pastikan konfigurasi default SPP per kelas tersimpan
            const initialSppConfig = ALL_GRADES.reduce((acc, grade) => ({ ...acc, [grade]: SPP_PER_MONTH }), {});
             try {
                await setDoc(configDocRef, { 
                    payment: { 
                        spp: initialSppConfig,
                        dsp: DSP_BASE_AMOUNT
                    } 
                }, { merge: true });
            } catch (e) {
                console.error("Error setting initial config:", e);
            }
        }
        
        // --- RENDERING KONTEN BERDASARKAN MENU AKTIF ---

        function renderContent() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            
            // Menentukan path untuk judul dinamis
            let displayPath = activeMenu;
            if (activeMenu === 'pembayaran' && currentPaymentTypeState !== 'cards') {
                displayPath = currentPaymentTypeState;
            } else if (activeMenu === 'transaksi_sekolah' && currentSchoolTxState !== 'cards') {
                displayPath = currentSchoolTxState;
            }
            
            updatePageTitle(displayPath); // Menggunakan path yang paling spesifik

            switch (activeMenu) {
                case 'dashboard':
                    renderDashboard(container);
                    break;
                case 'pembayaran':
                    renderPaymentPage(container); // Transaksi Siswa
                    break;
                case 'transaksi_sekolah':
                    renderSchoolTxPage(container); // Transaksi Sekolah
                    break;
                case 'siswa':
                    renderStudentsPage(container);
                    break;
                case 'siswa_rmp': // BARU: Siswa RMP
                    renderRMPStudentsPage(container);
                    break;
                case 'laporan':
                    renderReportPage(container);
                    break;
                case 'riwayat_admin': 
                    renderFullTransactionHistoryPage(container);
                    break;
                case 'laporan_keuangan': // BARU: Laporan Keuangan
                    renderFinancialReportPage(container);
                    break;
                case 'input_pemasukan': 
                    renderIncomeForm(container);
                    break;
                case 'input_pengeluaran': 
                    renderExpenseForm(container);
                    break;
                case 'pengaturan_app':
                    renderSettingsPage(container); // Diubah dari Dummy
                    break;
                default:
                    container.innerHTML = '<p class="text-center text-gray-500 mt-10">Menu tidak ditemukan atau belum diimplementasikan.</p>';
            }
        }
        
        // --- DASHBOARD ---
        function renderDashboard(container) {
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Utama</h1>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${renderCard('Total Siswa', summaryData.totalStudents, 'text-gray-900', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-500"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>')}
                    ${renderCard('Sisa Saldo Kas', formatCurrency(summaryData.schoolCash), 'text-blue-600', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-500"><path d="M14 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v4"/><line x1="22" x2="16" y1="17" y2="17"/><path d="M16 21v-4a2 2 0 0 1 2-2h2"/></svg>')}
                    ${renderCard('Total Dibayar (SPP)', formatCurrency(summaryData.totalPaid), 'text-green-600', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-500"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>')}
                    ${renderCard('Total Tunggakan', formatCurrency(summaryData.totalDue), 'text-red-600', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M10 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/><path d="M17 21v-4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v4"/><circle cx="12" cy="7" r="5"/></svg>')}
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Grafik Analitik -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Analitik Pembayaran SPP (Total Per Bulan)</h2>
                        <div id="spp-chart-container">
                            ${renderSPPChart(transactionsData)}
                        </div>
                    </div>
                    
                    <!-- Transaksi Terakhir -->
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">5 Transaksi Terakhir</h2>
                        ${renderLastTransactions(transactionsData)}
                    </div>
                </div>
            `;
        }
        
        function getSPPAmountByMonth(transactions) {
            const monthlyData = {};
            
            // Inisialisasi data untuk 12 bulan
            MONTHS.forEach(month => { monthlyData[month] = 0; });
            
            transactions.forEach(t => {
                // Hanya proses transaksi yang memiliki 'monthPaid' (transaksi SPP)
                if (t.monthPaid) {
                    const startMonthIndex = MONTHS.indexOf(t.monthPaid);
                    const monthsCount = t.monthsCount || 1;
                    
                    if (startMonthIndex !== -1) {
                        for (let i = 0; i < monthsCount; i++) {
                            const monthIndex = (startMonthIndex + i) % 12;
                            const monthName = MONTHS[monthIndex];
                            
                            // Distribusikan total amount secara merata per bulan
                            const monthlyShare = t.amount / monthsCount; 
                            monthlyData[monthName] += monthlyShare;
                        }
                    }
                }
            });
            
            return monthlyData;
        }

        function renderSPPChart(transactions) {
            const monthlyData = getSPPAmountByMonth(transactions);
            const dataValues = Object.values(monthlyData);
            const maxAmount = Math.max(...dataValues);
            const chartData = Object.entries(monthlyData);

            if (maxAmount === 0) {
                 return '<p class="text-gray-500 text-center py-10">Belum ada data pembayaran SPP untuk ditampilkan.</p>';
            }

            const bars = chartData.map(([month, amount]) => {
                const heightPercentage = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
                
                return `
                    <div class="bar-bar-wrapper">
                        <div class="bar" style="height: ${Math.max(10, heightPercentage)}%;">
                            <span class="bar-tooltip">${month}: ${formatCurrency(amount)}</span>
                        </div>
                        <span class="bar-bottom-label">${month.substring(0, 3)}</span>
                    </div>
                `;
            }).join('');

            return `
                <div class="bar-container border-b border-gray-200 pb-2">
                    ${bars}
                </div>
                <div class="mt-2 text-xs text-gray-500 flex justify-between">
                    <span>${formatCurrency(maxAmount)}</span>
                    <span>Rp 0</span>
                </div>
            `;
        }

        function renderCard(title, value, valueClass, iconHtml) {
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 flex items-center justify-between transition-transform hover:scale-[1.02] duration-300">
                    <div class="flex flex-col">
                        <p class="text-sm font-medium text-gray-500 uppercase">${title}</p>
                        <div class="mt-1 text-3xl font-bold ${valueClass}">
                            ${value}
                        </div>
                    </div>
                    <div class="p-3 rounded-full bg-indigo-100/50">
                        ${iconHtml}
                    </div>
                </div>
            `;
        }

        function renderLastTransactions(transactions) {
            const allTransactions = [
                ...transactions.map(t => ({...t, category: 'siswa', amount: t.amount})),
                ...cashTransactionsData.map(t => ({...t, category: 'kas', type: t.type, amount: t.type === 'EXPENSE' ? -t.amount : t.amount}))
            ].sort((a, b) => b.timestamp - a.timestamp);

            const lastFive = allTransactions.slice(0, 5);

            if (lastFive.length === 0) {
                return '<p class="text-gray-500 italic">Belum ada transaksi tercatat.</p>';
            }

            const rows = lastFive.map(t => {
                let nameInfo = 'Kas Sekolah';
                let typeInfo = '';
                let amountClass = 'text-gray-700';

                if (t.category === 'siswa') {
                    const student = studentsData.find(s => s.id === t.studentId) || { name: 'Siswa Dihapus', nis: '-' };
                    nameInfo = student.name;
                    
                    // Keterangan bulan untuk SPP atau N/A
                    let monthInfo = 'N/A';
                    if (t.monthPaid) {
                        if (t.monthsCount && t.monthsCount > 1) {
                            monthInfo = `${t.monthPaid} (+${t.monthsCount - 1} bln)`;
                        } else {
                            monthInfo = t.monthPaid;
                        }
                    }
                    
                    // Gunakan type dari transaksi
                    const type = t.type || 'Non-SPP'; 
                    let typeClass = 'text-green-600';
                    if (type === 'SPP') typeClass = 'text-indigo-600';
                    if (type === 'DSP') typeClass = 'text-red-600';
                    if (type === 'NON_SPP') typeClass = 'text-green-600'; // Tetapkan warna untuk Non SPP
                    
                    typeInfo = `<span class="${typeClass} font-medium">${type}</span> / ${monthInfo}`;
                    amountClass = 'text-green-700 font-semibold';
                    
                } else if (t.category === 'kas') {
                    nameInfo = t.description;
                    typeInfo = `<span class="${t.type === 'INCOME' ? 'text-blue-600' : 'text-red-600'} font-medium">${t.type === 'INCOME' ? 'PEMASUKAN' : 'PENGELUARAN'}</span>`;
                    amountClass = t.type === 'INCOME' ? 'text-blue-700 font-semibold' : 'text-red-700 font-semibold';
                }

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 border-b text-sm text-gray-700">${dayDateFormatter.format(t.timestamp).split(',')[0].substring(0, 3)} / ${timeFormatter.format(t.timestamp)}</td>
                        <td class="py-3 px-4 border-b font-medium text-gray-900">${nameInfo}</td>
                        <td class="py-3 px-4 border-b text-sm">${typeInfo}</td>
                        <td class="py-3 px-4 border-b text-sm ${amountClass}">${formatCurrency(Math.abs(t.amount))}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Keterangan</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipe Transaksi</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // --- SISWA (CRUD Sederhana) ---
        function sortStudents(students) {
            // Sortir berdasarkan Kelas (Grade), lalu NIS
            return students.sort((a, b) => {
                // Urutkan berdasarkan Kelas (Grade)
                if (a.grade < b.grade) return -1;
                if (a.grade > b.grade) return 1;
                
                // Jika kelas sama, urutkan berdasarkan NIS (string comparison for consistent order)
                if (a.nis < b.nis) return -1;
                if (a.nis > b.nis) return 1;
                return 0;
            });
        }
        
        async function handleStudentDelete(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return showModal("Siswa tidak ditemukan.", false, "Error");

            const confirmation = await showModal(`Apakah Anda yakin ingin menghapus data siswa ${student.name} (${student.nis})? Semua data pembayaran siswa ini akan tetap tercatat di riwayat, tetapi data master siswa akan hilang.`, true, "Konfirmasi Hapus Siswa");

            if (!confirmation) return;

            const studentsRef = getCollectionPath('students');
            const rmpRef = getCollectionPath('rmp_students');
            if (!studentsRef || !rmpRef) return showModal("Sistem Firebase belum siap.");

            try {
                // 1. Hapus dari koleksi Siswa
                await deleteDoc(doc(studentsRef, studentId));

                // 2. Hapus dari koleksi RMP (jika ada)
                const rmpDocId = rmpStudentsData.find(r => r.studentId === studentId)?.docId;
                if (rmpDocId) {
                    await deleteDoc(doc(rmpRef, rmpDocId));
                }

                showModal("Data siswa berhasil dihapus!", false, "Sukses");
            } catch (error) {
                console.error("Error deleting student:", error);
                showModal("Gagal menghapus data siswa: " + error.message, false, "Error");
            }
        }
        
        function renderStudentsPage(container) {
            // 1. Urutkan data siswa
            const sortedStudents = sortStudents([...studentsData]);

            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Manajemen Data Siswa</h1>
                
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <div class="flex gap-2">
                        <!-- Tombol Export -->
                        <button id="export-students-btn" class="flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Export CSV
                        </button>
                         <!-- Tombol Template -->
                        <button id="download-template-btn" class="flex items-center px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" x2="12" y1="13" y2="17"/><line x1="10" x2="14" y1="15" y2="15"/></svg>
                            Template CSV
                        </button>
                        <!-- Tombol Import -->
                        <button id="open-import-modal-btn" class="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M4 14.899V20a2 2 0 0 0 2 2h12c1.1 0 2-.9 2-2v-5.1"/><polyline points="16 16 12 12 8 16"/><line x1="12" x2="12" y1="12" y2="2"/></svg>
                            Import CSV
                        </button>
                    </div>
                    
                    <button id="add-student-btn" class="flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                        Tambah Siswa Baru
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIS</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Biaya SPP/bln</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="divide-y divide-gray-200">
                            ${sortedStudents.map(s => { // Menggunakan sortedStudents
                                const sppAmount = getStudentSPP(s.id, s.grade);
                                const baseSpp = (s.grade && appConfig.payment.spp[s.grade]) ? appConfig.payment.spp[s.grade] : SPP_PER_MONTH; 
                                const isRMP = sppAmount < baseSpp;
                                
                                return `
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="py-3 px-4 text-sm text-gray-700">${s.nis}</td>
                                    <td class="py-3 px-4 font-medium text-gray-900">${s.name} ${isRMP ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">RMP</span>' : ''}</td>
                                    <td class="py-3 px-4 text-sm text-gray-700">${s.grade}</td>
                                    <td class="py-3 px-4 text-sm text-gray-700 font-semibold">${formatCurrency(sppAmount)}</td>
                                    <td class="py-3 px-4 text-sm text-gray-700 space-x-2">
                                        <button data-id="${s.id}" class="edit-student-btn text-indigo-600 hover:text-indigo-900 font-medium">Edit</button>
                                        <button data-id="${s.id}" class="delete-student-btn text-red-600 hover:text-red-900 font-medium">Hapus</button>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                    ${sortedStudents.length === 0 ? '<p class="p-4 text-center text-gray-500 italic">Belum ada data siswa.</p>' : ''}
                </div>
                ${renderStudentFormModal()}
                ${renderImportModal()}
            `;
            
            document.getElementById('add-student-btn').addEventListener('click', () => openStudentModal());
            document.querySelectorAll('.edit-student-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const studentId = e.currentTarget.getAttribute('data-id');
                    const student = studentsData.find(s => s.id === studentId);
                    if (student) openStudentModal(student);
                });
            });
            document.querySelectorAll('.delete-student-btn').forEach(btn => { // Listener untuk Hapus
                btn.addEventListener('click', (e) => {
                    handleStudentDelete(e.currentTarget.getAttribute('data-id'));
                });
            });

            // Attach CSV/Import Listeners
            document.getElementById('export-students-btn').addEventListener('click', exportStudentsToCSV);
            document.getElementById('download-template-btn').addEventListener('click', downloadCSVTemplate);
            document.getElementById('open-import-modal-btn').addEventListener('click', () => {
                document.getElementById('import-students-modal').classList.remove('hidden');
                document.getElementById('import-students-modal').classList.add('flex');
            });
            document.getElementById('import-modal-close').addEventListener('click', () => {
                document.getElementById('import-students-modal').classList.remove('flex');
                document.getElementById('import-students-modal').classList.add('hidden');
            });
            document.getElementById('import-form').addEventListener('submit', handleImportSubmit);
            document.getElementById('import-file').addEventListener('change', handleFileSelect);

            // Tambahkan event listener untuk modal form (untuk mencegah rendering ulang)
            const modalClose = document.getElementById('student-modal-close');
            if (modalClose) modalClose.addEventListener('click', () => {
                document.getElementById('student-form-modal').classList.add('hidden');
            });
            const studentForm = document.getElementById('student-form');
            if (studentForm) studentForm.addEventListener('submit', handleStudentFormSubmit);
        }

        // --- CSV / IMPORT LOGIC (BARU) ---

        const CSV_HEADERS = ['NIS', 'NAMA_LENGKAP', 'KELAS'];
        const CSV_DELIMITER = ';';
        const BOM = '\ufeff'; // Byte Order Mark for Excel compatibility (UTF-8)

        function renderImportModal() {
            // Memastikan modal form hanya dirender sekali jika belum ada
            if (document.getElementById('import-students-modal')) return '';
            
            return `
                <div id="import-students-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Import Data Siswa dari CSV</h3>
                            <button id="import-modal-close" class="text-gray-400 hover:text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        
                        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 rounded-lg text-sm" role="alert">
                            <p class="font-bold">Perhatian Format:</p>
                            <p>Pastikan file CSV menggunakan <span class="font-mono font-bold">semicolon (;)</span> sebagai pemisah dan sesuai dengan urutan template (NIS;NAMA_LENGKAP;KELAS).</p>
                        </div>

                        <form id="import-form">
                            <div class="mb-4">
                                <label for="import-file" class="block text-sm font-medium text-gray-700 mb-1">Pilih File CSV Siswa</label>
                                <input type="file" id="import-file" accept=".csv" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            </div>
                            
                            <div id="import-status" class="mb-4 hidden">
                                <p class="text-sm font-medium text-gray-700">File terpilih: <span id="file-name-display" class="font-bold"></span></p>
                            </div>

                            <div class="flex justify-end pt-4">
                                <button type="submit" id="import-submit-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow-md flex items-center disabled:bg-gray-400" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M4 14.899V20a2 2 0 0 0 2 2h12c1.1 0 2-.9 2-2v-5.1"/><polyline points="16 16 12 12 8 16"/><line x1="12" x2="12" y1="12" y2="2"/></svg>
                                    Proses Import
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            const submitBtn = document.getElementById('import-submit-btn');
            const statusDiv = document.getElementById('import-status');
            const nameDisplay = document.getElementById('file-name-display');

            if (file) {
                submitBtn.disabled = false;
                nameDisplay.textContent = file.name;
                statusDiv.classList.remove('hidden');
            } else {
                submitBtn.disabled = true;
                statusDiv.classList.add('hidden');
            }
        }
        
        function downloadCSVTemplate() {
            const headerRow = CSV_HEADERS.join(CSV_DELIMITER);
            const dummyRow = ['00123', 'Nama Siswa Contoh', '8A'].join(CSV_DELIMITER);
            const csvContent = BOM + headerRow + "\n" + dummyRow;
            
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            
            // Membuat URL download
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "template_data_siswa_spp.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showModal("Browser Anda tidak mendukung download otomatis.", false, "Error Browser");
            }
        }

        function exportStudentsToCSV() {
            if (studentsData.length === 0) {
                return showModal("Tidak ada data siswa untuk diexport.", false, "Export Gagal");
            }

            const headerRow = CSV_HEADERS.join(CSV_DELIMITER);

            const dataRows = studentsData.map(s => {
                // Pastikan urutan sesuai dengan CSV_HEADERS
                const nis = s.nis || '';
                const name = s.name ? s.name.replace(/"/g, '""') : ''; // Escape quotes
                const grade = s.grade || '';

                return [nis, `"${name}"`, grade].join(CSV_DELIMITER);
            }).join('\n');

            const csvContent = BOM + headerRow + '\n' + dataRows;
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `data_siswa_${appConfig.general.schoolName.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showModal("Data siswa berhasil diexport sebagai file CSV.", false, "Export Sukses");
        }


        async function handleImportSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                return showModal("Pilih file CSV terlebih dahulu.", false, "Validasi Error");
            }

            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                 return showModal("Format file harus CSV.", false, "Validasi Error");
            }

            const reader = new FileReader();
            reader.onload = async function(event) {
                const csvText = event.target.result;
                
                // Hapus BOM jika ada
                const textWithoutBOM = csvText.startsWith(BOM) ? csvText.substring(1) : csvText;
                
                const lines = textWithoutBOM.trim().split('\n');
                if (lines.length <= 1) {
                    return showModal("File CSV kosong atau hanya berisi header.", false, "Import Gagal");
                }

                const headerRow = lines[0].trim().split(CSV_DELIMITER).map(h => h.trim().toUpperCase().replace(/"/g, ''));
                
                // Validasi Header
                if (headerRow.length !== CSV_HEADERS.length || !CSV_HEADERS.every(h => headerRow.includes(h))) {
                    return showModal(`Format header salah. Harusnya: ${CSV_HEADERS.join(';')} (pemisah semicolon).`, false, "Import Gagal");
                }
                
                const nisIndex = headerRow.indexOf('NIS');
                const nameIndex = headerRow.indexOf('NAMA_LENGKAP');
                const gradeIndex = headerRow.indexOf('KELAS');
                
                const newStudents = [];
                let errorCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Menggunakan regex untuk membagi baris berdasarkan semicolon, mengabaikan semicolon di dalam quotes
                    // Ini adalah solusi sederhana untuk CSV dengan quoted fields dan semicolon delimiter
                    const values = line.match(/(".*?"|[^;]+)(;|$)/g)
                                       .map(v => v.replace(/;$/, '').trim().replace(/^"(.*)"$/, '$1').trim());

                    if (values.length < CSV_HEADERS.length) {
                        console.warn(`Baris ${i + 1} dilewati (format kurang lengkap): ${line}`);
                        errorCount++;
                        continue;
                    }
                    
                    const nis = values[nisIndex].replace(/\D/g, '').trim(); // Pastikan NIS hanya angka
                    const name = values[nameIndex].trim();
                    const grade = values[gradeIndex].trim().toUpperCase();

                    if (!nis || !name || !ALL_GRADES.includes(grade)) {
                        errorCount++;
                        console.warn(`Baris ${i + 1} dilewati (data tidak valid): NIS='${nis}', Nama='${name}', Kelas='${grade}'`);
                        continue;
                    }
                    
                    // Cek duplikasi NIS/Siswa di data yang sudah ada (untuk mencegah duplikasi saat import)
                    if (studentsData.some(s => s.nis === nis)) {
                         errorCount++;
                         console.warn(`Baris ${i + 1} dilewati: NIS ${nis} sudah ada di database.`);
                         continue;
                    }

                    // Tambahkan ke array import
                    newStudents.push({
                        nis: nis,
                        name: name,
                        grade: grade,
                        sppPerMonth: SPP_PER_MONTH, // Default SPP, akan dihitung dinamis saat pembayaran
                        createdAt: serverTimestamp()
                    });
                }
                
                if (newStudents.length === 0) {
                    let msg = "Tidak ada data siswa baru yang valid untuk diimport.";
                    if (errorCount > 0) {
                         msg += ` Terdapat ${errorCount} baris yang dilewati karena format atau duplikasi NIS.`;
                    }
                    return showModal(msg, false, "Import Gagal");
                }

                // Konfirmasi sebelum menulis ke Firebase
                const confirmation = await showModal(
                    `Ditemukan ${newStudents.length} siswa baru yang valid. ${errorCount > 0 ? `(${errorCount} baris dilewati karena error/duplikasi).` : ''} Lanjutkan import?`, 
                    true, 
                    "Konfirmasi Import Data"
                );

                if (!confirmation) return;

                // --- EKSEKUSI FIREBASE BATCH WRITE ---
                const studentsRef = getCollectionPath('students');
                if (!studentsRef) return showModal("Sistem Firebase belum siap.");

                let successCount = 0;
                
                try {
                    // Masukkan data satu per satu (karena Firestore Web SDK tidak mendukung batch writes untuk addDoc)
                    for (const student of newStudents) {
                        await addDoc(studentsRef, student);
                        successCount++;
                    }
                    
                    document.getElementById('import-students-modal').classList.remove('flex');
                    document.getElementById('import-students-modal').classList.add('hidden');
                    fileInput.value = ''; // Clear file input
                    showModal(`Import Berhasil! ${successCount} siswa baru telah ditambahkan.`, false, "Import Sukses");
                    renderContent(); // Pemicu render untuk update tabel
                    
                } catch (error) {
                    console.error("Error during batch import:", error);
                    showModal(`Gagal menyimpan data ke Firebase. ${successCount} siswa berhasil, ${newStudents.length - successCount} gagal.`, false, "Error Import Firebase");
                }

            };

            reader.readAsText(file);
        }

        // --- END CSV / IMPORT LOGIC ---

        function renderStudentFormModal() {
            // Memastikan modal form hanya dirender sekali jika belum ada
            if (document.getElementById('student-form-modal')) return '';
            
            return `
                <div id="student-form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="student-modal-title" class="text-xl font-bold text-gray-800">Tambah Siswa</h3>
                            <button id="student-modal-close" class="text-gray-400 hover:text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <form id="student-form">
                            <input type="hidden" id="student-id-field" name="id">
                            <div class="mb-4">
                                <label for="nis" class="block text-sm font-medium text-gray-700 mb-1">NIS</label>
                                <input type="number" id="nis" name="nis" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="mb-4">
                                <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                                <input type="text" id="student-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="mb-4">
                                <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <select id="grade" name="grade" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option>
                                    <option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option>
                                    <option value="9A">9A</option><option value="9B">9B</option><option value="9C">9C</option>
                                </select>
                            </div>
                            <div class="flex justify-end pt-4">
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 shadow-md">Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function openStudentModal(student = null) {
            // Pastikan modal ada di DOM saat dipanggil (meski dirender secara kondisional)
            let modalEl = document.getElementById('student-form-modal');
            if (!modalEl) {
                // Tambahkan modal ke body jika belum ada
                document.body.insertAdjacentHTML('beforeend', renderStudentFormModal());
                modalEl = document.getElementById('student-form-modal');
                // Re-attach listeners setelah penambahan
                document.getElementById('student-modal-close').addEventListener('click', () => {
                    document.getElementById('student-form-modal').classList.add('hidden');
                });
                document.getElementById('student-form').addEventListener('submit', handleStudentFormSubmit);
            }

            const titleEl = document.getElementById('student-modal-title');
            const form = document.getElementById('student-form');
            
            form.reset();
            
            if (student) {
                titleEl.textContent = "Edit Siswa";
                document.getElementById('student-id-field').value = student.id;
                document.getElementById('nis').value = student.nis;
                document.getElementById('student-name').value = student.name;
                document.getElementById('grade').value = student.grade;
            } else {
                titleEl.textContent = "Tambah Siswa Baru";
                document.getElementById('student-id-field').value = '';
            }

            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        }

        async function handleStudentFormSubmit(e) {
            e.preventDefault();
            const modal = document.getElementById('student-form-modal');
            
            const studentId = document.getElementById('student-id-field').value;
            const studentData = {
                nis: document.getElementById('nis').value,
                name: document.getElementById('student-name').value,
                grade: document.getElementById('grade').value,
                sppPerMonth: SPP_PER_MONTH // Nilai tetap untuk SPP
            };
            
            // Cek duplikasi NIS
            const isNisDuplicate = studentsData.some(s => s.nis === studentData.nis && s.id !== studentId);
            if (isNisDuplicate) {
                 return showModal(`NIS ${studentData.nis} sudah digunakan oleh siswa lain.`, false, "Validasi Error");
            }

            const studentsRef = getCollectionPath('students');
            if (!studentsRef) return showModal("Sistem Firebase belum siap.");

            try {
                if (studentId) {
                    // Update
                    await updateDoc(doc(studentsRef, studentId), studentData);
                    showModal("Data siswa berhasil diperbarui!", false, "Sukses");
                } else {
                    // Add
                    await addDoc(studentsRef, {
                        ...studentData,
                        createdAt: serverTimestamp()
                    });
                    showModal("Siswa baru berhasil ditambahkan!", false, "Sukses");
                }
                modal.classList.add('hidden');
            } catch (error) {
                console.error("Error saving student:", error);
                showModal("Gagal menyimpan data siswa: " + error.message, false, "Error");
            }
        }

        // --- TRANSAKSI SISWA CONTROLLER ---

        function handleBackToCards() {
            currentPaymentTypeState = 'cards';
            renderContent();
        }

        function renderPaymentCardElement(title, type, bgColor, description, buttonClass = 'payment-card') {
            return `
                <button data-type="${type}" class="${buttonClass} w-full ${bgColor} text-white rounded-xl shadow-lg p-6 flex flex-col items-start transition-transform hover:scale-[1.03] duration-300">
                    <h3 class="text-2xl font-bold mb-2">${title}</h3>
                    <p class="text-sm opacity-90">${description}</p>
                    <span class="mt-4 text-xs font-semibold uppercase opacity-80 border border-white px-2 py-1 rounded-full">Pilih Transaksi</span>
                </button>
            `;
        }

        function attachCardListeners(selector, stateKey, newPath) {
            document.querySelectorAll(selector).forEach(card => {
                card.addEventListener('click', (e) => {
                    const type = e.currentTarget.getAttribute('data-type');
                    if (stateKey === 'payment') {
                        currentPaymentTypeState = type;
                    } else if (stateKey === 'school') {
                        currentSchoolTxState = type;
                        // Khusus untuk transaksi sekolah, kita pindah ke path spesifik
                        setActiveMenu(newPath);
                        return;
                    }
                    renderContent(); 
                });
            });
        }

        function renderPaymentCards(container) {
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Transaksi Siswa</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    ${renderPaymentCardElement('Pembayaran SPP', 'spp', 'bg-indigo-600', 'Untuk mencatat Iuran Bulanan Siswa.')}
                    ${renderPaymentCardElement('Pembayaran Non SPP', 'non_spp', 'bg-green-600', 'Untuk mencatat Pembayaran Non-rutin (buku, kegiatan, dll).')}
                    ${renderPaymentCardElement('Pembayaran DSP', 'dsp', 'bg-red-600', 'Untuk mencatat Dana Sumbangan Pendidikan (pendaftaran/bangunan).')}
                </div>
                
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Riwayat Transaksi Terakhir</h2>
                ${renderLastTransactions(transactionsData)}
            `;
            attachCardListeners('.payment-card', 'payment');
        }

        function handleClassChange(e, studentSelectId) {
            const selectedGrade = e.target.value;
            const studentSelect = document.getElementById(studentSelectId);

            // Bersihkan dropdown siswa
            studentSelect.innerHTML = '<option value="">--- Pilih Siswa ---</option>';

            const filteredStudents = selectedGrade 
                ? studentsData.filter(s => s.grade === selectedGrade) 
                : studentsData;

            filteredStudents.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.nis} - ${s.name} (${s.grade})`;
                studentSelect.appendChild(option);
            });
            
            // Panggil update status saat kelas berubah
            if (studentSelectId.includes('spp')) {
                // Biarkan studentSelectId yang memicu pembaruan
                updatePaymentStatus(); 
            } else if (studentSelectId.includes('dsp')) { // BARU: Tambahkan handler untuk DSP
                updateDSPStatus();
            }
        }

        /**
         * Mengambil status pembayaran SPP (bulan yang sudah lunas) untuk siswa yang dipilih.
         * @returns {Object} { paidMonths: string[], totalPaid: number }
         */
        function getStudentPaymentStatus(studentId) {
            if (!studentId) return { paidMonths: [], totalPaid: 0 };

            const studentTransactions = transactionsData.filter(t => t.studentId === studentId && t.monthPaid);
            let paidMonths = new Set();
            let totalPaid = 0;

            studentTransactions.forEach(t => {
                totalPaid += t.amount;
                
                // Cek apakah transaksi adalah pembayaran multi-bulan
                if (t.monthsCount && t.monthsCount > 1) {
                    const startMonthIndex = MONTHS.indexOf(t.monthPaid);
                    if (startMonthIndex !== -1) {
                        for (let i = 0; i < t.monthsCount; i++) {
                            const monthIndex = (startMonthIndex + i) % 12;
                            paidMonths.add(MONTHS[monthIndex]);
                        }
                    }
                } else if (t.monthPaid) {
                    // Pembayaran 1 bulan
                    paidMonths.add(t.monthPaid);
                }
            });

            return { paidMonths: Array.from(paidMonths), totalPaid };
        }
        
        /**
         * Memperbarui tampilan bulan SPP dan informasi tunggakan.
         */
        function updatePaymentStatus() {
            const studentSelect = document.getElementById('student-select-spp');
            const monthSelect = document.getElementById('month-select');
            const infoDiv = document.getElementById('payment-info');
            const studentId = studentSelect ? studentSelect.value : null;
            const student = studentId ? studentsData.find(s => s.id === studentId) : null;

            if (!studentId || !studentSelect || !student) {
                if (infoDiv) infoDiv.innerHTML = '<p class="text-gray-500">Pilih Siswa untuk melihat status pembayaran SPP.</p>';
                if (monthSelect) monthSelect.innerHTML = '<option value="">--- Pilih Bulan ---</option>';
                return;
            }
            
            // Dapatkan SPP bulanan siswa yang sebenarnya (setelah diskon dan per kelas)
            const studentSPP = getStudentSPP(studentId, student.grade);
            const baseSpp = (student.grade && appConfig.payment.spp[student.grade]) ? appConfig.payment.spp[student.grade] : SPP_PER_MONTH; 

            const studentSPPFormatted = formatCurrency(studentSPP);

            const { paidMonths, totalPaid } = getStudentPaymentStatus(studentId);
            const totalDue = (MAX_MONTHS * studentSPP) - totalPaid;
            const dueMonths = MONTHS.filter(m => !paidMonths.includes(m));
            
            const isRMP = studentSPP < baseSpp;
            const rmpInfo = isRMP ? 
                `<span class="text-red-600 font-bold"> (RMP: Diskon ${rmpDiscountRate}%)</span>` : '';
            
            const baseSppFormatted = formatCurrency(baseSpp);

            // Perbarui info tunggakan
            if (infoDiv) {
                infoDiv.innerHTML = `
                    <p class="text-sm font-semibold mb-2">Biaya SPP Kelas ${student.grade} (Normal ${baseSppFormatted}): <span class="text-indigo-700">${studentSPPFormatted}</span>${rmpInfo}</p>
                    <p class="text-xs ${totalDue > 0 ? 'text-red-600' : 'text-green-600'}">
                        Total Tunggakan: ${formatCurrency(totalDue)}
                    </p>
                    <p class="text-xs text-gray-700">
                        Bulan yang Belum Lunas: ${dueMonths.length > 0 ? dueMonths.join(', ') : 'Lunas (12 bulan)'}
                    </p>
                `;
            }

            // Perbarui dropdown bulan: hanya tampilkan bulan yang BELUM dibayar
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="">--- Pilih Bulan Awal ---</option>';
                dueMonths.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    monthSelect.appendChild(option);
                });
            }
            
            // Perbarui nilai SPP per bulan di form (hidden input)
            document.getElementById('amount-per-month-input').value = studentSPP;
            updateAmount(); // Panggil updateAmount untuk merefresh total

        }
        
        /**
         * Menghitung dan memperbarui jumlah total bayar.
         */
        function updateAmount() {
            const monthsCountInput = document.getElementById('months-count');
            const totalAmountDisplay = document.getElementById('total-amount-display');
            const amountPerMonthInput = document.getElementById('amount-per-month-input');
            
            if (monthsCountInput && totalAmountDisplay && amountPerMonthInput) {
                const studentSPP = parseInt(amountPerMonthInput.value) || SPP_PER_MONTH;
                const monthsCount = parseInt(monthsCountInput.value) || 1;
                const totalAmount = monthsCount * studentSPP;
                
                totalAmountDisplay.value = formatCurrency(totalAmount);
                // Set nilai amount sebenarnya (integer) ke hidden field
                document.getElementById('amount-input').value = totalAmount; 
            }
        }
        
        // Menangani submit pembayaran SPP
        async function handlePaymentSubmit(e) {
            e.preventDefault();

            const studentId = document.getElementById('student-select-spp').value;
            const monthPaid = document.getElementById('month-select').value;
            const monthsCount = parseInt(document.getElementById('months-count').value);
            const amount = parseInt(document.getElementById('amount-input').value);
            const studentSPP = parseInt(document.getElementById('amount-per-month-input').value);

            if (!studentId || !monthPaid || monthsCount < 1 || isNaN(amount) || amount <= 0) {
                return showModal("Pastikan Siswa, Bulan Awal, dan Jumlah Bulan sudah dipilih/diisi.", false, "Validasi Error");
            }

            // --- VALIDASI BULAN LUNAS ---
            const { paidMonths } = getStudentPaymentStatus(studentId);
            const startMonthIndex = MONTHS.indexOf(monthPaid);
            
            if (startMonthIndex === -1) {
                 return showModal("Bulan Awal tidak valid.", false, "Error Internal");
            }

            // Memeriksa semua bulan dalam rentang pembayaran
            const monthsToPay = [];
            for (let i = 0; i < monthsCount; i++) {
                const monthIndex = (startMonthIndex + i) % 12;
                const monthName = MONTHS[monthIndex];
                
                if (paidMonths.includes(monthName)) {
                    return showModal(`Pembayaran dibatalkan. Bulan ${monthName} sudah lunas!`, false, "Gagal Mencatat");
                }
                monthsToPay.push(monthName);
            }
            
            // --- VALIDASI JUMLAH NOMINAL (Penting untuk RMP) ---
            const expectedAmount = monthsCount * studentSPP;
            if (amount !== expectedAmount) {
                return showModal(`Kesalahan jumlah. Nominal harusnya ${formatCurrency(expectedAmount)} untuk ${monthsCount} bulan.`, false, "Validasi Nominal");
            }
            
            const confirmation = await showModal(
                `Konfirmasi Pembayaran: ${monthsCount} bulan SPP (mulai ${monthPaid}) untuk siswa ${studentId} sejumlah ${formatCurrency(amount)}. Lanjutkan?`, 
                true, 
                "Konfirmasi Pembayaran SPP"
            );

            if (!confirmation) return;

            // --- EKSEKUSI FIREBASE ---
            const transactionsRef = getCollectionPath('transactions');
            if (!transactionsRef) return showModal("Sistem Firebase belum siap.");

            const transactionData = {
                studentId: studentId,
                amount: amount,
                monthPaid: monthPaid,
                monthsCount: monthsCount,
                type: 'SPP', // Tipe SPP
                timestamp: serverTimestamp(),
                recordedBy: userId,
                // Tambahkan detail RMP/Diskon
                sppPerMonthActual: studentSPP, 
                isRMP: studentSPP < appConfig.payment.spp[studentsData.find(s => s.id === studentId).grade] 
            };

            try {
                await addDoc(transactionsRef, transactionData);
                showModal("Pembayaran SPP berhasil dicatat!", false, "Sukses");
                // Reset form
                document.getElementById('payment-form').reset();
                handleClassChange({target: {value: ''}}, 'student-select-spp'); 

            } catch (error) {
                console.error("Error saving SPP transaction:", error);
                showModal("Gagal mencatat transaksi SPP: " + error.message, false, "Error");
            }
        }


        // --- FORMULIR SPP (Fungsional) ---
        function renderSPPFormContent() {
            
            const gradeOptions = ALL_GRADES.map(g => `<option value="${g}">${g}</option>`).join('');
            const initialStudentOptions = `<option value="">--- Pilih Siswa ---</option>`;

            return `
                <div class="flex items-center mb-6">
                    <button id="back-to-cards" class="flex items-center text-indigo-600 hover:text-indigo-800 font-semibold mr-4 p-2 rounded-full hover:bg-indigo-100 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Kembali
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">Pembayaran SPP Bulanan</h1>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-2xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700">Form Transaksi SPP</h2>
                    
                    <!-- Info Pembayaran Siswa -->
                    <div id="payment-info" class="bg-indigo-50 p-3 mb-4 rounded-lg border border-indigo-200">
                        <p class="text-gray-500">Pilih Siswa untuk melihat status pembayaran SPP.</p>
                    </div>

                    <form id="payment-form">
                        <input type="hidden" id="amount-input" name="amount" value="${SPP_PER_MONTH}">
                        <input type="hidden" id="amount-per-month-input" value="${SPP_PER_MONTH}"> 
                        
                        <!-- Kelas dan Siswa -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="grade-select-spp" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas</label>
                                <select id="grade-select-spp" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">--- Semua Kelas ---</option>
                                    ${gradeOptions}
                                </select>
                            </div>
                            <div>
                                <label for="student-select-spp" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                                <select id="student-select-spp" name="studentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    ${initialStudentOptions}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bulan & Jumlah Bulan -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="month-select" class="block text-sm font-medium text-gray-700 mb-1">Bulan Awal SPP (Belum Lunas)</label>
                                <select id="month-select" name="monthPaid" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">--- Pilih Bulan Awal ---</option>
                                </select>
                            </div>
                            <div>
                                <label for="months-count" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Bulan Bayar</label>
                                <input type="number" id="months-count" name="monthsCount" required min="1" max="${MAX_MONTHS}" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>

                        <!-- Total Bayar (Dihitung Otomatis) -->
                        <div class="mb-6">
                            <label for="total-amount-display" class="block text-sm font-medium text-gray-700 mb-1">TOTAL BAYAR</label>
                            <input type="text" id="total-amount-display" readonly class="w-full px-3 py-3 border border-indigo-500 bg-indigo-50 text-2xl font-bold text-indigo-700 rounded-lg">
                        </div>
                        
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 shadow-md flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                Catat Pembayaran
                            </button>
                        </div>
                    </form>
                </div>
                
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Riwayat Transaksi SPP</h2>
                ${renderTransactionHistory(transactionsData)}
            `;
        }
        
        // Menampilkan riwayat transaksi yang difilter (SPP saja)
        function renderTransactionHistory(transactions) {
             const sppTransactions = transactions.filter(t => t.type === 'SPP');
             const sortedTransactions = [...sppTransactions].sort((a, b) => b.timestamp - a.timestamp);

            if (sortedTransactions.length === 0) {
                return '<p class="text-gray-500 italic">Belum ada transaksi SPP tercatat.</p>';
            }

            const rows = sortedTransactions.map(t => {
                const student = studentsData.find(s => s.id === t.studentId) || { name: 'Siswa Dihapus', nis: '-' };
                
                let monthInfo = t.monthPaid;
                if (t.monthsCount && t.monthsCount > 1) {
                    monthInfo = `${t.monthPaid} (+${t.monthsCount - 1} bln)`;
                }
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 border-b text-sm text-gray-700 whitespace-nowrap">${dayDateFormatter.format(t.timestamp).split(',')[0].substring(0, 3)} / ${timeFormatter.format(t.timestamp)}</td>
                        <td class="py-3 px-4 border-b font-medium text-gray-900">${student.name}</td>
                        <td class="py-3 px-4 border-b text-sm text-indigo-600">${monthInfo}</td>
                        <td class="py-3 px-4 border-b text-sm text-green-700 font-semibold">${formatCurrency(t.amount)}</td>
                        <td class="py-3 px-4 border-b text-sm">
                            <button data-doc-id="${t.id}" data-collection="transactions" class="delete-tx-btn text-red-600 hover:text-red-800 font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Siswa</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Bulan Dibayar</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- FORMULIR NON SPP (Fungsional) ---
        
        // Menangani submit pembayaran Non SPP
        async function handleNonSPPPaymentSubmit(e) {
            e.preventDefault();

            const form = e.target;
            const studentId = form.studentId.value;
            const description = form.description.value.trim();
            const amount = parseInt(form.amount.value);
            
            const student = studentsData.find(s => s.id === studentId);

            if (!studentId || !description || isNaN(amount) || amount <= 0) {
                return showModal("Pastikan Siswa, Keterangan, dan Jumlah Bayar sudah diisi dengan benar.", false, "Validasi Error");
            }
            
            const confirmation = await showModal(
                `Konfirmasi Pembayaran Non SPP: Siswa ${student.name} membayar ${formatCurrency(amount)} untuk '${description}'. Lanjutkan?`, 
                true, 
                "Konfirmasi Pembayaran Non SPP"
            );

            if (!confirmation) return;

            // --- EKSEKUSI FIREBASE ---
            const transactionsRef = getCollectionPath('transactions');
            if (!transactionsRef) return showModal("Sistem Firebase belum siap.");

            const transactionData = {
                studentId: studentId,
                amount: amount,
                description: description, // Keterangan transaksi Non SPP
                type: 'NON_SPP', // Tipe NON_SPP
                timestamp: serverTimestamp(),
                recordedBy: userId,
            };

            try {
                await addDoc(transactionsRef, transactionData);
                showModal("Pembayaran Non SPP berhasil dicatat!", false, "Sukses");
                // Reset form
                form.reset();
                handleClassChange({target: {value: ''}}, 'student-select-non'); 

            } catch (error) {
                console.error("Error saving Non SPP transaction:", error);
                showModal("Gagal mencatat transaksi Non SPP: " + error.message, false, "Error");
            }
        }
        
        // Menampilkan riwayat transaksi Non SPP
        function renderNonSPPTransactionHistory(transactions) {
             const nonSppTransactions = transactions.filter(t => t.type === 'NON_SPP');
             const sortedTransactions = [...nonSppTransactions].sort((a, b) => b.timestamp - a.timestamp);

            if (sortedTransactions.length === 0) {
                return '<p class="text-gray-500 italic">Belum ada transaksi Non SPP tercatat.</p>';
            }

            const rows = sortedTransactions.map(t => {
                const student = studentsData.find(s => s.id === t.studentId) || { name: 'Siswa Dihapus', nis: '-' };
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 border-b text-sm text-gray-700 whitespace-nowrap">${dayDateFormatter.format(t.timestamp).split(',')[0].substring(0, 3)} / ${timeFormatter.format(t.timestamp)}</td>
                        <td class="py-3 px-4 border-b font-medium text-gray-900">${student.name}</td>
                        <td class="py-3 px-4 border-b text-sm text-gray-600">${t.description || 'N/A'}</td>
                        <td class="py-3 px-4 border-b text-sm text-green-700 font-semibold">${formatCurrency(t.amount)}</td>
                        <td class="py-3 px-4 border-b text-sm">
                            <button data-doc-id="${t.id}" data-collection="transactions" class="delete-tx-btn text-red-600 hover:text-red-800 font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Siswa</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Keterangan</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderNonSPPFormContent() {
            const gradeOptions = ALL_GRADES.map(g => `<option value="${g}">${g}</option>`).join('');
            const initialStudentOptions = `<option value="">--- Pilih Siswa ---</option>`;

            return `
                <div class="flex items-center mb-6">
                    <button id="back-to-cards" class="flex items-center text-indigo-600 hover:text-indigo-800 font-semibold mr-4 p-2 rounded-full hover:bg-indigo-100 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Kembali
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">Pembayaran Non SPP (Buku/Kegiatan)</h1>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-2xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-green-700">Form Transaksi Non SPP</h2>
                    <p class="text-gray-600 mb-6">Fitur ini ditujukan untuk mencatat transaksi siswa yang tidak berhubungan dengan SPP rutin, seperti pembelian buku pelajaran, biaya ekstrakurikuler, atau iuran kegiatan.</p>
                    <form id="non-spp-form">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="grade-select-non" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas</label>
                                <select id="grade-select-non" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                    <option value="">--- Semua Kelas ---</option>
                                    ${gradeOptions}
                                </select>
                            </div>
                            <div>
                                <label for="student-select-non" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                                <select id="student-select-non" name="studentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                    ${initialStudentOptions}
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="keterangan-non" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Transaksi</label>
                            <input type="text" id="keterangan-non" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Contoh: Pembelian Buku Semester Ganjil">
                        </div>
                        <div class="mb-4">
                            <label for="amount-non" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Bayar (IDR)</label>
                            <input type="number" id="amount-non" name="amount" required min="1000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Minimum 1000">
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                Catat Transaksi
                            </button>
                        </div>
                    </form>
                </div>
                
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Riwayat Transaksi Non SPP</h2>
                ${renderNonSPPTransactionHistory(transactionsData)}
            `;
        }

        /**
         * Mengambil total DSP yang sudah dibayar oleh siswa.
         * @param {string} studentId
         * @returns {number} totalDSPPaid
         */
        function getStudentDSPPaid(studentId) {
            if (!studentId) return 0;
            return transactionsData
                .filter(t => t.studentId === studentId && t.type === 'DSP')
                .reduce((sum, t) => sum + t.amount, 0);
        }

        /**
         * Memperbarui tampilan DSP (Dana Sumbangan Pendidikan)
         * Termasuk total due dan kalkulasi sisa tunggakan.
         */
        function updateDSPStatus() {
            const studentSelect = document.getElementById('student-select-dsp');
            const totalDSPDueDisplay = document.getElementById('total-dsp-due');
            const totalDSPPaidDisplay = document.getElementById('total-dsp-paid');
            const totalDSPRemainingDisplay = document.getElementById('total-dsp-remaining');
            const studentId = studentSelect ? studentSelect.value : null;
            const student = studentId ? studentsData.find(s => s.id === studentId) : null;
            
            // Dapatkan total DSP yang seharusnya dibayar
            const baseDSP = appConfig.payment.dsp || DSP_BASE_AMOUNT;
            const finalDSPDue = studentId ? getStudentDSP(studentId) : baseDSP;
            const isRMP = studentId && (finalDSPDue < baseDSP);
            
            // Dapatkan yang sudah dibayar
            const paidDSP = getStudentDSPPaid(studentId);
            
            // Hitung Sisa Tunggakan DSP
            const remainingDSP = Math.max(0, finalDSPDue - paidDSP);
            
            // Update Tampilan Info
            if (totalDSPDueDisplay) totalDSPDueDisplay.textContent = formatCurrency(finalDSPDue);
            if (totalDSPPaidDisplay) totalDSPPaidDisplay.textContent = formatCurrency(paidDSP);
            
            if (totalDSPRemainingDisplay) {
                totalDSPRemainingDisplay.textContent = formatCurrency(remainingDSP);
                if (remainingDSP > 0) {
                    totalDSPRemainingDisplay.classList.remove('text-green-600');
                    totalDSPRemainingDisplay.classList.add('text-red-600');
                } else {
                    totalDSPRemainingDisplay.classList.remove('text-red-600');
                    totalDSPRemainingDisplay.classList.add('text-green-600');
                }
            }
            
            // Update input amount saat ini (trigger calculation)
            updateDSPCalculation();
            
            // Atur informasi RMP
            const rmpInfoEl = document.getElementById('dsp-rmp-info');
            if (rmpInfoEl) {
                if (isRMP) {
                    rmpInfoEl.innerHTML = `<p class="text-xs text-red-600 font-bold mt-1">Siswa RMP: Diskon ${rmpDiscountRate}%. Harga Normal: <span class="line-through">${formatCurrency(baseDSP)}</span></p>`;
                    rmpInfoEl.classList.remove('hidden');
                } else {
                    rmpInfoEl.classList.add('hidden');
                }
            }
            
            // Sembunyikan form jika siswa belum dipilih
            const formContainer = document.getElementById('dsp-form-container');
            if (formContainer) {
                if (studentId) {
                    formContainer.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    formContainer.classList.add('opacity-50', 'pointer-events-none');
                }
            }
        }
        
        /**
         * Menghitung sisa tunggakan riil berdasarkan Total DSP Due dan Pembayaran Saat Ini
         * Sisa ini yang akan dicatat sebagai tunggakan siswa
         */
        function updateDSPCalculation() {
            const studentSelect = document.getElementById('student-select-dsp');
            const studentId = studentSelect ? studentSelect.value : null;
            
            if (!studentId) return;

            // Dapatkan total DSP yang belum lunas (setelah pembayaran sebelumnya)
            const finalDSPDue = getStudentDSP(studentId);
            const paidDSP = getStudentDSPPaid(studentId);
            const initialRemaining = Math.max(0, finalDSPDue - paidDSP);

            // Ambil pembayaran saat ini
            const amountPaidNowInput = document.getElementById('amount-paid-dsp');
            let amountPaidNow = parseInt(amountPaidNowInput.value) || 0;
            
            // Batasi Pembayaran Saat Ini tidak melebihi Sisa Awal
            if (amountPaidNow > initialRemaining) {
                 amountPaidNow = initialRemaining;
                 amountPaidNowInput.value = initialRemaining;
            }
            
            const remainingDebt = initialRemaining - amountPaidNow;
            
            // Update tampilan Sisa Tunggakan
            const debtDisplay = document.getElementById('remaining-debt-dsp-display');
            if (debtDisplay) {
                debtDisplay.textContent = formatCurrency(remainingDebt);
                debtDisplay.classList.remove('text-red-600', 'text-green-600');
                if (remainingDebt > 0) {
                     debtDisplay.classList.add('text-red-600');
                } else {
                     debtDisplay.classList.add('text-green-600');
                }
            }

            // Update hidden input total DSP due (digunakan saat submit)
            document.getElementById('dsp-total-due-hidden').value = finalDSPDue;
        }
        
        /**
         * Menangani pilihan metode pembayaran (Lunas/Cicilan)
         */
        function toggleDSPPaymentType(isInstallment) {
            const amountPaidInput = document.getElementById('amount-paid-dsp');
            const totalDSPDue = parseInt(document.getElementById('dsp-total-due-hidden').value);
            
            // Jika Lunas, set pembayaran saat ini = sisa yang belum dibayar
            if (!isInstallment) {
                const paidDSP = getStudentDSPPaid(document.getElementById('student-select-dsp').value);
                const toPay = Math.max(0, totalDSPDue - paidDSP);
                amountPaidInput.value = toPay;
                amountPaidInput.disabled = true; // Tidak bisa diedit jika lunas
            } else {
                amountPaidInput.disabled = false;
                amountPaidInput.value = 0; // Reset ke 0 jika cicilan
            }
            updateDSPCalculation();
        }

        // --- FORMULIR DSP (Fungsional Cicilan) ---
        function renderDSPFormContent() {
            const gradeOptions = ALL_GRADES.map(g => `<option value="${g}">${g}</option>`).join('');
            const initialStudentOptions = `<option value="">--- Pilih Siswa ---</option>`;
            const baseDSP = appConfig.payment.dsp || DSP_BASE_AMOUNT;
            
            // Total DSP yang mungkin (untuk inisialisasi display)
            const initialDSP = getStudentDSP('dummy'); 

            return `
                <div class="flex items-center mb-6">
                    <button id="back-to-cards" class="flex items-center text-indigo-600 hover:text-indigo-800 font-semibold mr-4 p-2 rounded-full hover:bg-indigo-100 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Kembali
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">Pembayaran DSP (Dana Sumbangan Pendidikan)</h1>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-2xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-red-700">Form Transaksi DSP (Cicilan)</h2>
                    
                    <form id="dsp-form">
                        <input type="hidden" id="dsp-total-due-hidden" value="${initialDSP}">
                        
                        <!-- Kelas dan Siswa -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="grade-select-dsp" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas</label>
                                <select id="grade-select-dsp" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">--- Semua Kelas ---</option>
                                    ${gradeOptions}
                                </select>
                            </div>
                            <div>
                                <label for="student-select-dsp" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                                <select id="student-select-dsp" name="studentId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                                    ${initialStudentOptions}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Ringkasan DSP Siswa -->
                        <div class="bg-red-50 p-4 mb-6 rounded-lg border border-red-200">
                            <div class="grid grid-cols-2 gap-4 text-sm font-medium">
                                <span>Total DSP Wajib Bayar:</span>
                                <span id="total-dsp-due" class="font-bold text-red-700">${formatCurrency(0)}</span>
                                
                                <span>Total DSP Sudah Dibayar:</span>
                                <span id="total-dsp-paid" class="font-bold text-green-700">${formatCurrency(0)}</span>
                                
                                <span>Sisa Awal Belum Lunas:</span>
                                <span id="initial-remaining-dsp" class="font-bold text-red-600">${formatCurrency(0)}</span>
                            </div>
                            <div id="dsp-rmp-info" class="hidden text-center mt-2"></div>
                        </div>

                        <!-- Form Pembayaran (Dapat Dicicil) -->
                        <div id="dsp-form-container" class="opacity-50 pointer-events-none">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Input Pembayaran Saat Ini</h3>
                            
                            <!-- Pilihan Metode Pembayaran (Lunas/Cicilan) -->
                            <div class="mb-4">
                                <span class="block text-sm font-medium text-gray-700 mb-2">Jenis Pembayaran</span>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="radio" name="paymentTypeDSP" id="dsp-payment-full" value="full" 
                                               class="form-radio h-4 w-4 text-green-600 focus:ring-green-500"
                                               checked>
                                        <span class="ml-2 text-gray-700">Bayar Lunas (Sisa)</span>
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="radio" name="paymentTypeDSP" id="dsp-payment-installment" value="installment" 
                                               class="form-radio h-4 w-4 text-red-600 focus:ring-red-500">
                                        <span class="ml-2 text-gray-700">Cicilan (Partial)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Jumlah Bayar Saat Ini (Uang Muka) -->
                            <div class="mb-6">
                                <label for="amount-paid-dsp" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Bayar Saat Ini (Uang Muka/Cicilan) (Rp)</label>
                                <input type="number" id="amount-paid-dsp" name="amount" required min="1000" class="w-full px-3 py-3 border border-red-500 rounded-lg text-xl font-bold focus:ring-red-500 focus:border-red-500" value="0">
                                <p class="text-xs text-gray-500 mt-1">Nominal ini tidak boleh melebihi sisa DSP yang belum lunas.</p>
                            </div>
                        </div>

                        <!-- HASIL KALKULASI SISA TUNGGAKAN -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center py-2 px-4 bg-red-100/50 rounded-lg">
                                <span class="text-base font-semibold text-gray-800">SISA TUNGGAKAN DSP (Dicatat ke Tunggakan Siswa)</span>
                                <span id="remaining-debt-dsp-display" class="text-2xl font-extrabold text-red-600">${formatCurrency(initialDSP)}</span>
                            </div>
                        </div>

                        <div class="flex justify-end pt-6">
                            <button type="submit" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 shadow-xl flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="m12 5 7 7-7 7"/><path d="M5 12h14"/></svg>
                                Catat Pembayaran DSP
                            </button>
                        </div>
                    </form>
                </div>
                
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Riwayat Transaksi DSP</h2>
                ${renderDSPTransactionHistory(transactionsData)}
            `;
        }
        
        async function handleDSPPaymentSubmit(e) {
            e.preventDefault();

            const studentId = document.getElementById('student-select-dsp').value;
            const amountPaidNow = parseInt(document.getElementById('amount-paid-dsp').value);
            const dspTotalDue = parseInt(document.getElementById('dsp-total-due-hidden').value);
            
            // Re-calculate remaining debt for final check
            const paidDSPBefore = getStudentDSPPaid(studentId);
            const initialRemaining = Math.max(0, dspTotalDue - paidDSPBefore);
            const remainingDebtAfter = initialRemaining - amountPaidNow;

            if (!studentId || isNaN(amountPaidNow) || amountPaidNow <= 0) {
                return showModal("Pilih Siswa dan masukkan Jumlah Bayar yang valid.", false, "Validasi Error");
            }
            
            if (amountPaidNow > initialRemaining) {
                 return showModal(`Pembayaran saat ini (${formatCurrency(amountPaidNow)}) melebihi sisa yang harus dibayar (${formatCurrency(initialRemaining)}).`, false, "Validasi Error");
            }
            
            const student = studentsData.find(s => s.id === studentId) || { name: 'Siswa Dihapus' };
            const isFullPayment = remainingDebtAfter === 0;
            const paymentType = isFullPayment ? 'Lunas' : 'Cicilan';

            const confirmation = await showModal(
                `Konfirmasi Pembayaran DSP: Siswa ${student.name} membayar ${formatCurrency(amountPaidNow)} (${paymentType}). Sisa Tunggakan: ${formatCurrency(remainingDebtAfter)}. Lanjutkan?`, 
                true, 
                "Konfirmasi Pembayaran DSP"
            );

            if (!confirmation) return;

            // --- EKSEKUSI FIREBASE ---
            const transactionsRef = getCollectionPath('transactions');
            if (!transactionsRef) return showModal("Sistem Firebase belum siap.");

            const transactionData = {
                studentId: studentId,
                amount: amountPaidNow,
                type: 'DSP', // Tipe DSP
                timestamp: serverTimestamp(),
                recordedBy: userId,
                // Data khusus untuk DSP Tracking
                dspTotalDue: dspTotalDue,
                dspPaidBefore: paidDSPBefore,
                dspRemainingDebt: remainingDebtAfter,
                dspPaymentType: paymentType,
            };

            try {
                await addDoc(transactionsRef, transactionData);
                showModal(`Pembayaran DSP ${paymentType} berhasil dicatat! Sisa tunggakan: ${formatCurrency(remainingDebtAfter)}.`, false, "Sukses");
                // Reset form
                document.getElementById('dsp-form').reset();
                handleClassChange({target: {value: ''}}, 'student-select-dsp'); // Re-initialize fields

            } catch (error) {
                console.error("Error saving DSP transaction:", error);
                showModal("Gagal mencatat transaksi DSP: " + error.message, false, "Error");
            }
        }
        
        function renderDSPTransactionHistory(transactions) {
             const dspTransactions = transactions.filter(t => t.type === 'DSP');
             const sortedTransactions = [...dspTransactions].sort((a, b) => b.timestamp - a.timestamp);

            if (sortedTransactions.length === 0) {
                return '<p class="text-gray-500 italic">Belum ada transaksi DSP tercatat.</p>';
            }

            const rows = sortedTransactions.map(t => {
                const student = studentsData.find(s => s.id === t.studentId) || { name: 'Siswa Dihapus', nis: '-' };
                const isFull = t.dspRemainingDebt === 0;
                const statusClass = isFull ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 border-b text-sm text-gray-700 whitespace-nowrap">${dayDateFormatter.format(t.timestamp).split(',')[0].substring(0, 3)} / ${timeFormatter.format(t.timestamp)}</td>
                        <td class="py-3 px-4 border-b font-medium text-gray-900">${student.name}</td>
                        <td class="py-3 px-4 border-b text-sm text-red-600 font-semibold">${formatCurrency(t.amount)}</td>
                        <td class="py-3 px-4 border-b text-sm">
                            <span class="font-bold">${formatCurrency(t.dspRemainingDebt || 0)}</span>
                        </td>
                        <td class="py-3 px-4 border-b text-xs">
                             <span class="px-2 py-0.5 rounded-full ${statusClass}">${t.dspPaymentType || (isFull ? 'Lunas' : 'Cicilan')}</span>
                        </td>
                        <td class="py-3 px-4 border-b text-sm">
                            <button data-doc-id="${t.id}" data-collection="transactions" class="delete-tx-btn text-red-600 hover:text-red-800 font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Siswa</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Bayar Saat Ini</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sisa Tunggakan</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }


        function renderPaymentPage(container) {
            // Logic Controller untuk Transaksi Siswa
            switch (currentPaymentTypeState) {
                case 'spp':
                    container.innerHTML = renderSPPFormContent();
                    
                    document.getElementById('payment-form').addEventListener('submit', handlePaymentSubmit);
                    document.getElementById('back-to-cards').addEventListener('click', handleBackToCards);
                    
                    // Setup listener untuk Kelas
                    document.getElementById('grade-select-spp').addEventListener('change', (e) => {
                        handleClassChange(e, 'student-select-spp');
                        updatePaymentStatus(); // Panggil ulang untuk siswa baru
                    });
                    
                    // Setup listener untuk Siswa
                    document.getElementById('student-select-spp').addEventListener('change', updatePaymentStatus); 
                    
                    // Setup listener untuk Jumlah Bulan dan Bulan Awal
                    document.getElementById('months-count').addEventListener('input', updateAmount);
                    document.getElementById('month-select').addEventListener('change', updateAmount); 
                    
                    // Panggil sekali untuk mengisi daftar kelas/siswa dan status awal
                    handleClassChange({target: {value: ''}}, 'student-select-spp'); 
                    updatePaymentStatus(); 
                    updateAmount();
                    
                    break;
                case 'non_spp':
                    container.innerHTML = renderNonSPPFormContent();
                    document.getElementById('back-to-cards').addEventListener('click', handleBackToCards);
                    
                    // Setup listener untuk Kelas dan inisialisasi Siswa
                    document.getElementById('grade-select-non').addEventListener('change', (e) => handleClassChange(e, 'student-select-non'));
                    handleClassChange({target: {value: ''}}, 'student-select-non'); 

                    // ATTACH NEW SUBMIT HANDLER
                    document.getElementById('non-spp-form').addEventListener('submit', handleNonSPPPaymentSubmit);
                    break;
                case 'dsp':
                    container.innerHTML = renderDSPFormContent(); 
                    document.getElementById('back-to-cards').addEventListener('click', handleBackToCards);

                    // Setup listener untuk Kelas dan inisialisasi Siswa
                    document.getElementById('grade-select-dsp').addEventListener('change', (e) => {
                        handleClassChange(e, 'student-select-dsp');
                        updateDSPStatus(); // Panggil update DSP
                    });
                    document.getElementById('student-select-dsp').addEventListener('change', () => {
                        updateDSPStatus();
                        // Reset pilihan lunas/cicilan saat siswa berubah
                        document.querySelector('input[name="paymentTypeDSP"][value="full"]').checked = true;
                        toggleDSPPaymentType(false);
                    });
                    
                    // Setup listener untuk Pilihan Pembayaran DSP (FIX for ReferenceError)
                    document.getElementById('dsp-payment-full').addEventListener('change', () => toggleDSPPaymentType(false));
                    document.getElementById('dsp-payment-installment').addEventListener('change', () => toggleDSPPaymentType(true));

                    // Setup listener untuk Amount Paid Now
                    document.getElementById('amount-paid-dsp').addEventListener('input', updateDSPCalculation);
                    
                    // Form Submit
                    document.getElementById('dsp-form').addEventListener('submit', handleDSPPaymentSubmit);
                    
                    // Inisialisasi awal
                    handleClassChange({target: {value: ''}}, 'student-select-dsp'); 
                    updateDSPStatus();
                    toggleDSPPaymentType(false); // Default Lunas
                    
                    break;
                case 'cards':
                default:
                    renderPaymentCards(container);
                    break;
            }
        }
        
        // --- TRANSAKSI SEKOLAH CONTROLLER (Fungsional) ---

        function handleBackToSchoolCards() {
            // Ini dipanggil oleh tombol 'Kembali' dari form Income/Expense
            currentSchoolTxState = 'cards';
            setActiveMenu('transaksi_sekolah');
        }

        function renderSchoolTxCards(container) {
             container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Transaksi Sekolah (Kas & Pengeluaran)</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto">
                    ${renderPaymentCardElement('Input Pemasukan Sekolah', 'input_pemasukan', 'bg-blue-600', 'Mencatat dana masuk non-SPP (bantuan, bunga bank, dll).', 'school-tx-card')}
                    ${renderPaymentCardElement('Input Pengeluaran Sekolah', 'input_pengeluaran', 'bg-red-600', 'Mencatat dana keluar (gaji, operasional, inventaris).', 'school-tx-card')}
                </div>

                <h2 class="text-2xl font-semibold text-gray-800 mb-4">5 Transaksi Kas Terakhir</h2>
                ${renderCashTransactionHistory(cashTransactionsData)}
            `;
            // Attach listeners to the new cards. Note: path is set to the specific form name
            document.querySelectorAll('.school-tx-card').forEach(card => {
                const type = card.getAttribute('data-type');
                card.addEventListener('click', () => {
                    setActiveMenu(type); // Pindah langsung ke halaman formulir
                });
            });
        }
        
        function renderSchoolTxPage(container) {
            // Logic Controller untuk Transaksi Sekolah (hanya menampilkan kartu pilihan)
            switch (currentSchoolTxState) {
                case 'cards':
                default:
                    renderSchoolTxCards(container);
                    break;
            }
        }
        
        // --- FORMULIR PEMASUKAN SEKOLAH (Fungsional) ---
        function renderIncomeForm(container) {
            container.innerHTML = `
                <div class="flex items-center mb-6">
                    <button id="back-to-school-cards" class="flex items-center text-indigo-600 hover:text-indigo-800 font-semibold mr-4 p-2 rounded-full hover:bg-indigo-100 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Kembali
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">Input Pemasukan Sekolah</h1>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-blue-700">Catat Dana Masuk (Non-Siswa)</h2>
                    <form id="income-form">
                        <div class="mb-4">
                            <label for="income-description" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Pemasukan</label>
                            <input type="text" id="income-description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Bantuan BOS, Donasi Alumni">
                        </div>
                        <div class="mb-4">
                            <label for="income-amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Pemasukan (IDR)</label>
                            <input type="number" id="income-amount" name="amount" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Minimum 1">
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow-md flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                Catat Pemasukan
                            </button>
                        </div>
                    </form>
                </div>
                
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Riwayat Pemasukan Kas</h2>
                ${renderCashTransactionHistory(cashTransactionsData.filter(t => t.type === 'INCOME'))}
            `;
            
            document.getElementById('back-to-school-cards').addEventListener('click', handleBackToSchoolCards);
            document.getElementById('income-form').addEventListener('submit', (e) => handleCashTransactionSubmit(e, 'INCOME'));
        }

        // --- FORMULIR PENGELUARAN SEKOLAH (Fungsional) ---
        function renderExpenseForm(container) {
            container.innerHTML = `
                <div class="flex items-center mb-6">
                    <button id="back-to-school-cards" class="flex items-center text-indigo-600 hover:text-indigo-800 font-semibold mr-4 p-2 rounded-full hover:bg-indigo-100 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Kembali
                    </button>
                    <h1 class="text-3xl font-bold text-gray-800">Input Pengeluaran Sekolah</h1>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-red-700">Catat Dana Keluar</h2>
                    <form id="expense-form">
                        <div class="mb-4">
                            <label for="expense-description" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Pengeluaran</label>
                            <input type="text" id="expense-description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Contoh: Pembelian ATK, Gaji Karyawan">
                        </div>
                        <div class="mb-4">
                            <label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Pengeluaran (IDR)</label>
                            <input type="number" id="expense-amount" name="amount" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Minimum 1">
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 shadow-md flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M5 12h14"/></svg>
                                Catat Pengeluaran
                            </button>
                        </div>
                    </form>
                </div>
                
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Riwayat Pengeluaran Kas</h2>
                ${renderCashTransactionHistory(cashTransactionsData.filter(t => t.type === 'EXPENSE'))}
            `;
            
            document.getElementById('back-to-school-cards').addEventListener('click', handleBackToSchoolCards);
            document.getElementById('expense-form').addEventListener('submit', (e) => handleCashTransactionSubmit(e, 'EXPENSE'));
        }

        async function handleCashTransactionSubmit(e, type) {
            e.preventDefault();
            
            const form = e.target;
            const description = form.description.value.trim();
            const amountInput = form.amount.value;
            const amount = parseInt(amountInput);

            if (!description || isNaN(amount) || amount <= 0) {
                return showModal("Pastikan deskripsi diisi dan jumlah nominal benar.", false, "Validasi Error");
            }
            
            const cashTransactionsRef = getCollectionPath('school_cash_transactions');
            if (!cashTransactionsRef) return showModal("Sistem Firebase belum siap.");

            // Data transaksi kas
            const transactionData = {
                description: description,
                amount: amount,
                type: type, // 'INCOME' atau 'EXPENSE'
                timestamp: serverTimestamp(),
                recordedBy: userId
            };

            try {
                 const actionVerb = type === 'INCOME' ? 'Pemasukan' : 'Pengeluaran';
                 const confirmation = await showModal(
                    `Anda akan mencatat ${actionVerb} sebesar ${formatCurrency(amount)} untuk '${description}'. Lanjutkan?`, 
                    true, 
                    "Konfirmasi Transaksi Kas"
                );

                if (!confirmation) return;
                
                await addDoc(cashTransactionsRef, transactionData);
                showModal(`${actionVerb} berhasil dicatat!`, false, "Sukses");
                form.reset();
            } catch (error) {
                console.error(`Error saving ${type} transaction:`, error);
                showModal(`Gagal mencatat ${type}: ` + error.message, false, "Error");
            }
        }
        
        function renderCashTransactionHistory(transactions) {
            const sortedTransactions = [...transactions].sort((a, b) => b.timestamp - a.timestamp);

            if (sortedTransactions.length === 0) {
                return '<p class="text-gray-500 italic">Belum ada transaksi kas tercatat.</p>';
            }

            const rows = sortedTransactions.map(t => {
                const amountClass = t.type === 'INCOME' ? 'text-blue-700' : 'text-red-700';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 border-b text-sm text-gray-700 whitespace-nowrap">${dayDateFormatter.format(t.timestamp).split(',')[0].substring(0, 3)} / ${timeFormatter.format(t.timestamp)}</td>
                        <td class="py-3 px-4 border-b font-medium text-gray-900">${t.description}</td>
                        <td class="py-3 px-4 border-b text-sm ${amountClass} font-semibold">${formatCurrency(t.amount)}</td>
                        <td class="py-3 px-4 border-b text-sm text-gray-500">${t.type}</td>
                        <td class="py-3 px-4 border-b text-sm">
                            <button data-doc-id="${t.id}" data-collection="school_cash_transactions" class="delete-tx-btn text-red-600 hover:text-red-800 font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Deskripsi</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipe</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- RIWAYAT TRANSAKSI GLOBAL ---
        function renderFullTransactionHistoryPage(container) {
            // 1. Gabungkan semua transaksi (Siswa dan Kas)
            const allTransactions = [];

            // Tambahkan Transaksi Siswa
            transactionsData.forEach(t => {
                const student = studentsData.find(s => s.id === t.studentId) || { name: 'Siswa Dihapus', nis: '-' };
                
                let source = student.name;
                let description = 'Pembayaran Siswa';
                let type;
                
                if (t.monthPaid) {
                    type = 'SPP';
                    let monthInfo = t.monthPaid;
                    if (t.monthsCount && t.monthsCount > 1) {
                         const startMonthIndex = MONTHS.indexOf(t.monthPaid);
                         const endMonthIndex = (startMonthIndex + t.monthsCount - 1) % 12;
                         monthInfo = `${MONTHS[startMonthIndex]} - ${MONTHS[endMonthIndex]}`;
                    }
                    description = `SPP ${monthInfo}`;
                } else {
                    // Cek tipe DSP atau NON_SPP
                    type = t.type || 'Non-SPP'; 
                    if (type === 'DSP') {
                        description = `DSP (${t.dspPaymentType || 'Lunas/Cicilan'})`;
                    } else if (type === 'NON_SPP') {
                        description = t.description || 'Pembayaran Non-SPP (Kegiatan)';
                    }
                }

                allTransactions.push({
                    id: t.id,
                    collection: 'transactions',
                    timestamp: t.timestamp,
                    source: source,
                    description: description,
                    type: type,
                    amount: t.amount,
                    isIncome: true
                });
            });

            // Tambahkan Transaksi Kas Sekolah
            cashTransactionsData.forEach(t => {
                 allTransactions.push({
                    id: t.id,
                    collection: 'school_cash_transactions',
                    timestamp: t.timestamp,
                    source: 'Kas Sekolah',
                    description: t.description,
                    type: t.type,
                    amount: t.amount,
                    isIncome: (t.type === 'INCOME')
                });
            });

            // 2. Urutkan berdasarkan waktu terbaru
            allTransactions.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());

            const rows = allTransactions.map(t => {
                const amountClass = t.isIncome ? 'text-green-700' : 'text-red-700';
                const typeClass = t.isIncome ? 'text-green-600' : 'text-red-600';
                const displayType = t.type === 'INCOME' ? 'PEMASUKAN' : (t.type === 'EXPENSE' ? 'PENGELUARAN' : t.type);

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4 border-b text-sm text-gray-700 whitespace-nowrap">${dayDateFormatter.format(t.timestamp).split(',')[0].substring(0, 3)} / ${timeFormatter.format(t.timestamp)}</td>
                        <td class="py-3 px-4 border-b font-medium text-gray-900">${t.source}</td>
                        <td class="py-3 px-4 border-b text-sm text-gray-700">${t.description}</td>
                        <td class="py-3 px-4 border-b text-sm"><span class="${typeClass} font-medium">${displayType}</span></td>
                        <td class="py-3 px-4 border-b text-sm ${amountClass} font-semibold text-right">${formatCurrency(t.amount)}</td>
                        <td class="py-3 px-4 border-b text-sm">
                            <button data-doc-id="${t.id}" data-collection="${t.collection}" class="delete-tx-btn text-red-600 hover:text-red-800 font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Riwayat Transaksi Global</h1>
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sumber/Penerima</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Keterangan</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipe</th>
                                <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah (IDR)</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${allTransactions.length > 0 ? rows : `
                                <tr><td colspan="6" class="p-4 text-center text-gray-500 italic">Belum ada transaksi yang tercatat dalam sistem.</td></tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // --- LAPORAN KEUANGAN (BARU) ---
        
        /**
         * Menghitung dan mengeksport Laporan Keuangan ke format CSV (delimiter ; dan BOM).
         */
        function exportFinancialReportToCSV() {
            // 1. Hitung total pemasukan dan pengeluaran (sama seperti di renderFinancialReportPage)
            const totalSPP = transactionsData
                .filter(t => t.type === 'SPP')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalNonSPPDSP = transactionsData
                .filter(t => t.type === 'DSP' || t.type === 'NON_SPP')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalIncomeKas = cashTransactionsData
                .filter(t => t.type === 'INCOME')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = cashTransactionsData
                .filter(t => t.type === 'EXPENSE')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalIncomeGlobal = totalSPP + totalNonSPPDSP + totalIncomeKas;
            const netIncome = totalIncomeGlobal - totalExpense;
            const currentCash = summaryData.schoolCash;
            
            // --- FORMAT CSV ---
            const CSV_DELIMITER_FINANCE = ';';
            const BOM_CHAR = '\ufeff';

            // 2. Data Laporan Keuangan (Menggunakan format yang mudah diimpor Excel)
            const reportData = [
                ['Laporan Keuangan Sekolah', appConfig.general.schoolName, `Tahun Ajaran: ${appConfig.general.year}`],
                ['Waktu Ekspor', dayDateFormatter.format(new Date()), `Pencatat: ${userId}`.substring(0, 40) + '...'],
                [''],
                ['Kategori', 'Pemasukan (Rp)', 'Pengeluaran (Rp)', 'Keterangan'],
                ['Pemasukan SPP Siswa', totalSPP, 0, 'Pembayaran SPP Bulanan dari siswa'],
                ['Pemasukan Non-SPP/DSP', totalNonSPPDSP, 0, 'Pembayaran DSP dan Non-SPP Siswa'],
                ['Pemasukan Kas Sekolah', totalIncomeKas, 0, 'Dana Masuk Non-Siswa (BOS, Donasi, dll)'],
                ['Pengeluaran Kas Sekolah', 0, totalExpense, 'Dana Keluar Operasional, Gaji, dll.'],
                [''],
                ['TOTAL PEMASUKAN', totalIncomeGlobal, '', ''],
                ['TOTAL PENGELUARAN', '', totalExpense, ''],
                ['LABA BERSIH (Pemasukan - Pengeluaran)', netIncome, '', netIncome >= 0 ? 'Laba Bersih' : 'Defisit'],
                [''],
                ['SALDO KAS SAAT INI', currentCash, '', 'Saldo riil yang ada di rekening/kas.']
            ];

            // Convert data array to CSV string
            const csvContent = reportData.map(row => 
                row.map(cell => {
                    // Pastikan sel yang mengandung koma atau semicolon dikelilingi oleh quotes.
                    let str = String(cell);
                    if (typeof cell === 'number') {
                        str = cell.toString(); // Gunakan format number murni untuk perhitungan di Excel
                    } else {
                        // Escape quotes dan tambahkan quotes jika ada semicolon atau baris baru
                        str = str.replace(/"/g, '""');
                        if (str.includes(CSV_DELIMITER_FINANCE) || str.includes('\n') || str.includes('"')) {
                            str = `"${str}"`;
                        }
                    }
                    return str;
                }).join(CSV_DELIMITER_FINANCE)
            ).join('\n');

            // 3. Trigger Download
            const finalCsv = BOM_CHAR + csvContent;
            const blob = new Blob([finalCsv], { type: "text/csv;charset=utf-8;" });
            
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Laporan_Keuangan_${appConfig.general.year.replace(/\//g, '_')}_${new Date().toISOString().slice(0,10)}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showModal("Laporan Keuangan berhasil diexport sebagai file CSV.", false, "Export Sukses");
        }
        
        function renderFinancialReportPage(container) {
             // 1. Hitung total pemasukan dan pengeluaran
            const totalSPP = transactionsData
                .filter(t => t.type === 'SPP')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalNonSPPDSP = transactionsData
                .filter(t => t.type === 'DSP' || t.type === 'NON_SPP') // Hanya DSP dan Non_SPP
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalIncomeKas = cashTransactionsData
                .filter(t => t.type === 'INCOME')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = cashTransactionsData
                .filter(t => t.type === 'EXPENSE')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalIncomeGlobal = totalSPP + totalNonSPPDSP + totalIncomeKas;
            const netIncome = totalIncomeGlobal - totalExpense;


            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Laporan Keuangan Sekolah</h1>
                
                <div class="flex justify-end mb-4">
                     <button id="download-finance-btn" class="flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Download Laporan CSV
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    ${renderCard('Total Pemasukan (Global)', formatCurrency(totalIncomeGlobal), 'text-green-600', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-500"><path d="M12 5v14"/><path d="M5 12h14"/></svg>')}
                    ${renderCard('Total Pengeluaran', formatCurrency(totalExpense), 'text-red-600', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M5 12h14"/></svg>')}
                    ${renderCard('Laba Bersih / Defisit', formatCurrency(netIncome), netIncome >= 0 ? 'text-blue-600' : 'text-red-700', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-500"><path d="M12 19V5"/><polyline points="5 12 12 5 19 12"/></svg>')}
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Detail Arus Kas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Pemasukan -->
                        <div>
                            <h3 class="text-lg font-semibold text-green-600 mb-2">Pemasukan (Total: ${formatCurrency(totalIncomeGlobal)})</h3>
                            <ul class="space-y-1 text-sm text-gray-700">
                                <li class="flex justify-between border-b pb-1">
                                    <span>Pemasukan SPP Siswa:</span>
                                    <span class="font-medium">${formatCurrency(totalSPP)}</span>
                                </li>
                                <li class="flex justify-between border-b pb-1">
                                    <span>Pemasukan Non-SPP/DSP:</span>
                                    <span class="font-medium">${formatCurrency(totalNonSPPDSP)}</span>
                                </li>
                                <li class="flex justify-between border-b pb-1">
                                    <span>Pemasukan Kas Sekolah:</span>
                                    <span class="font-medium">${formatCurrency(totalIncomeKas)}</span>
                                </li>
                            </ul>
                            <p class="mt-3 text-md font-bold text-green-700">Total Saldo Kas Saat Ini: ${formatCurrency(summaryData.schoolCash)}</p>
                        </div>
                        
                        <!-- Pengeluaran -->
                        <div>
                            <h3 class="text-lg font-semibold text-red-600 mb-2">Pengeluaran (Total: ${formatCurrency(totalExpense)})</h3>
                            <ul class="space-y-1 text-sm text-gray-700">
                                <li class="flex justify-between border-b pb-1 italic">
                                    <span>Pengeluaran Kas Sekolah:</span>
                                    <span class="font-medium text-red-600">${formatCurrency(totalExpense)}</span>
                                </li>
                            </ul>
                            <p class="mt-3 text-sm text-gray-500">Catatan: Pengeluaran siswa tidak dicatat, hanya pengeluaran Kas Sekolah.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Attach listener to the new button inside renderFinancialReportPage
            document.getElementById('download-finance-btn').addEventListener('click', exportFinancialReportToCSV);
        }

        
        // --- MANAJEMEN SISWA RMP (BARU) ---
        function renderRMPStudentsPage(container) {
            
            // 1. Urutkan siswa non-RMP berdasarkan kelas (untuk dropdown)
            const nonRMPStudents = studentsData.filter(s => 
                !rmpStudentsData.some(rmp => rmp.studentId === s.id)
            );
            const sortedNonRMPStudents = sortStudents([...nonRMPStudents]); // Menggunakan fungsi sortStudents

            
            const rmpStudentIds = rmpStudentsData.map(r => r.studentId);
            const currentRMPList = studentsData.filter(s => rmpStudentIds.includes(s.id));
            
            // 2. Buat opsi dropdown yang sudah terurut
            const studentOptions = sortedNonRMPStudents.map(s => 
                `<option value="${s.id}">${s.grade} - ${s.nis} - ${s.name}</option>` // Urutan: Kelas - NIS - Nama
            ).join('');
            
            const baseSpp = appConfig.payment.spp[ALL_GRADES[0]] || SPP_PER_MONTH; // Ambil SPP default dari kelas 7A
            
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Siswa RMP (Potongan SPP)</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Kiri: Pengaturan Diskon RMP -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-red-700 mb-4">Pengaturan Diskon RMP</h2>
                        <p class="text-sm text-gray-600 mb-4">Diskon ini berlaku untuk semua siswa RMP pada SPP dan DSP.</p>
                        
                        <form id="rmp-discount-form">
                            <div class="mb-4">
                                <label for="rmp-rate" class="block text-sm font-medium text-gray-700 mb-1">Persentase Diskon SPP/DSP (%)</label>
                                <input type="number" id="rmp-rate" name="discountRate" required min="0" max="100" value="${rmpDiscountRate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                            </div>
                            <p class="text-xs text-gray-500 mb-4">SPP baru per bulan (Contoh Kelas 7A): <span class="font-bold text-red-600">${formatCurrency(getStudentSPP('any_id', '7A'))}</span> | DSP baru: <span class="font-bold text-red-600">${formatCurrency(getStudentDSP('any_id'))}</span></p>
                            <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
                                Simpan Diskon
                            </button>
                        </form>
                    </div>

                    <!-- Kolom Kanan: Tambah Siswa RMP -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-indigo-700 mb-4">Tambah Siswa ke Daftar RMP</h2>
                        <form id="add-rmp-student-form">
                            <div class="mb-4">
                                <label for="rmp-student-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa (Non-RMP)</label>
                                <select id="rmp-student-select" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">--- Pilih Siswa ---</option>
                                    ${studentOptions}
                                </select>
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-400" ${nonRMPStudents.length === 0 ? 'disabled' : ''}>
                                Tambahkan Siswa
                            </button>
                            ${nonRMPStudents.length === 0 ? '<p class="text-xs text-center text-gray-500 mt-2">Semua siswa sudah terdaftar atau tidak ada data siswa.</p>' : ''}
                        </form>
                    </div>
                </div>
                
                <!-- Daftar Siswa RMP -->
                <h2 class="text-2xl font-bold text-gray-800 my-6">Daftar Siswa RMP (${rmpDiscountRate}% Diskon)</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIS</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">SPP Normal (Kelas)</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">SPP Setelah Diskon</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${currentRMPList.map(s => {
                                const sppDiscounted = getStudentSPP(s.id, s.grade);
                                const baseSpp = (s.grade && appConfig.payment.spp[s.grade]) ? appConfig.payment.spp[s.grade] : SPP_PER_MONTH; 
                                const rmpDoc = rmpStudentsData.find(r => r.studentId === s.id);

                                return `
                                    <tr class="hover:bg-red-50 transition-colors">
                                        <td class="py-3 px-4 text-sm text-gray-700">${s.nis}</td>
                                        <td class="py-3 px-4 font-medium text-red-800">${s.name}</td>
                                        <td class="py-3 px-4 text-sm text-gray-700">${s.grade}</td>
                                        <td class="py-3 px-4 text-sm text-gray-500 line-through">${formatCurrency(baseSpp)}</td>
                                        <td class="py-3 px-4 text-sm text-red-600 font-bold">${formatCurrency(sppDiscounted)}</td>
                                        <td class="py-3 px-4 text-sm">
                                            <button data-id="${rmpDoc.docId}" class="remove-rmp-btn text-red-600 hover:text-red-800 font-medium">Hapus dari RMP</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    ${currentRMPList.length === 0 ? '<p class="p-4 text-center text-gray-500 italic">Belum ada siswa terdaftar dalam program RMP.</p>' : ''}
                </div>
            `;
            
            // Attach Event Listeners
            document.getElementById('rmp-discount-form').addEventListener('submit', handleRMPDiscountSubmit);
            document.getElementById('rmp-rate').addEventListener('input', updateRMPRateDisplay);
            document.getElementById('add-rmp-student-form').addEventListener('submit', handleAddRMPStudent);
            document.querySelectorAll('.remove-rmp-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleRemoveRMPStudent(e.currentTarget.getAttribute('data-id')));
            });
            
            // Tambahkan event listener change untuk menampilkan SPP setelah diskon saat input
            function updateRMPRateDisplay() {
                const rate = parseInt(document.getElementById('rmp-rate').value) || 0;
                const newSPP = (appConfig.payment.spp['7A'] || SPP_PER_MONTH) * (1 - (rate / 100)); // Menggunakan 7A sebagai contoh
                const newDSP = (appConfig.payment.dsp || DSP_BASE_AMOUNT) * (1 - (rate / 100));
                const textEl = document.querySelector('#rmp-discount-form p.text-xs');
                if (textEl) {
                    textEl.innerHTML = `SPP baru per bulan (Contoh Kelas 7A): <span class="font-bold text-red-600">${formatCurrency(newSPP)}</span> | DSP baru: <span class="font-bold text-red-600">${formatCurrency(newDSP)}</span>`;
                }
            }
            updateRMPRateDisplay(); // Panggil sekali untuk inisialisasi
        }
        
        async function handleRMPDiscountSubmit(e) {
            e.preventDefault();
            const rate = parseInt(document.getElementById('rmp-rate').value);
            
            if (isNaN(rate) || rate < 0 || rate > 100) {
                return showModal("Persentase diskon harus antara 0 hingga 100.", false, "Validasi Error");
            }

            const rmpRef = getCollectionPath('rmp_students');
            if (!rmpRef) return showModal("Sistem Firebase belum siap.");
            
            try {
                // Simpan rate di dokumen konfigurasi tunggal
                await setDoc(doc(rmpRef, 'discount_config'), { 
                    discountRate: rate 
                }, { merge: true });

                rmpDiscountRate = rate; // Update state lokal segera
                showModal(`Persentase diskon RMP berhasil diperbarui menjadi ${rate}%.`, false, "Sukses");
            } catch (error) {
                console.error("Error saving RMP discount rate:", error);
                showModal("Gagal menyimpan diskon RMP: " + error.message, false, "Error");
            }
        }
        
        async function handleAddRMPStudent(e) {
            e.preventDefault();
            const studentId = document.getElementById('rmp-student-select').value;
            
            if (!studentId) {
                return showModal("Pilih siswa yang akan ditambahkan ke daftar RMP.", false, "Validasi Error");
            }

            const rmpRef = getCollectionPath('rmp_students');
            if (!rmpRef) return showModal("Sistem Firebase belum siap.");
            
            try {
                // Tambahkan ID siswa ke koleksi RMP
                // Gunakan studentId sebagai ID dokumen agar unik
                await setDoc(doc(rmpRef, studentId), { 
                    studentId: studentId, 
                    addedAt: serverTimestamp() 
                });

                showModal(`Siswa berhasil ditambahkan ke daftar RMP (Diskon ${rmpDiscountRate}%).`, false, "Sukses");
                // Perubahan akan dirender ulang oleh listener Firestore
            } catch (error) {
                console.error("Error adding RMP student:", error);
                showModal("Gagal menambahkan siswa RMP: " + error.message, false, "Error");
            }
        }

        async function handleRemoveRMPStudent(docId) {
            const confirmation = await showModal("Apakah Anda yakin ingin menghapus siswa ini dari daftar RMP? SPP akan kembali ke harga normal.", true, "Konfirmasi Penghapusan");
            
            if (!confirmation) return;
            
            const rmpRef = getCollectionPath('rmp_students');
            if (!rmpRef) return showModal("Sistem Firebase belum siap.");

            try {
                // Hapus dokumen RMP menggunakan docId yang merupakan studentId
                await deleteDoc(doc(rmpRef, docId)); 
                showModal("Siswa berhasil dihapus dari daftar RMP.", false, "Sukses");
                // Perubahan akan dirender ulang oleh listener Firestore
            } catch (error) {
                console.error("Error removing RMP student:", error);
                showModal("Gagal menghapus siswa RMP: " + error.message, false, "Error");
            }
        }

        // --- PENGATURAN (BARU) ---

        function renderSettingsPage(container) {
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Pengaturan Aplikasi</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Pengaturan Umum -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Pengaturan Umum Sekolah</h2>
                        <form id="general-settings-form">
                            <div class="mb-4">
                                <label for="school-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                                <input type="text" id="school-name" name="schoolName" required value="${appConfig.general.schoolName}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran (Contoh: 2024/2025)</label>
                                <input type="text" id="year" name="year" required value="${appConfig.general.year}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Sekolah</label>
                                <textarea id="address" name="address" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">${appConfig.general.address}</textarea>
                            </div>
                            <div class="mb-6">
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label>
                                <input type="text" id="phone" name="phone" required value="${appConfig.general.phone}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 shadow-md">Simpan Pengaturan Umum</button>
                            </div>
                        </form>
                    </div>

                    <!-- Pengaturan Pembayaran -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">2. Pengaturan Nominal Pembayaran</h2>
                        <form id="payment-settings-form">
                            <!-- DSP NOMINAL -->
                            <div class="mb-6 border-b pb-4">
                                <h3 class="text-lg font-semibold mb-2">Nominal DSP Dasar</h3>
                                <label for="dsp-amount" class="block text-sm font-medium text-gray-700 mb-1">Nominal DSP (Rp)</label>
                                <input type="number" id="dsp-amount" name="dsp" required min="0" value="${appConfig.payment.dsp}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">Diskon RMP akan diterapkan pada nominal ini.</p>
                            </div>
                            
                            <!-- SPP PER KELAS -->
                            <h3 class="text-lg font-semibold mb-2">Nominal SPP Bulanan per Kelas</h3>
                            ${ALL_GRADES.map(grade => `
                                <div class="mb-3">
                                    <label for="spp-${grade}" class="block text-sm font-medium text-gray-700 mb-1">Kelas ${grade} (Rp)</label>
                                    <input type="number" id="spp-${grade}" name="${grade}" required min="0" value="${appConfig.payment.spp[grade] || SPP_PER_MONTH}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            `).join('')}
                            
                            <div class="flex justify-end pt-4">
                                <button type="submit" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 shadow-md">Simpan Nominal Pembayaran</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Attach Event Listeners
            document.getElementById('general-settings-form').addEventListener('submit', handleGeneralSettingsSubmit);
            document.getElementById('payment-settings-form').addEventListener('submit', handlePaymentSettingsSubmit);
        }

        async function handleGeneralSettingsSubmit(e) {
            e.preventDefault();
            const form = e.target;
            
            const generalData = {
                schoolName: form.schoolName.value,
                year: form.year.value,
                address: form.address.value,
                phone: form.phone.value,
            };

            const configDocRef = getDocPath('app_config', 'settings');
            if (!configDocRef) return showModal("Sistem Firebase belum siap.");

            try {
                // Update hanya bagian 'general' dari dokumen settings
                await setDoc(configDocRef, { 
                    general: generalData 
                }, { merge: true });

                showModal("Pengaturan umum berhasil disimpan!", false, "Sukses");
            } catch (error) {
                console.error("Error saving general settings:", error);
                showModal("Gagal menyimpan pengaturan umum: " + error.message, false, "Error");
            }
        }
        
        async function handlePaymentSettingsSubmit(e) {
            e.preventDefault();
            const form = e.target;
            
            const dspAmount = parseInt(form.dsp.value);
            if (isNaN(dspAmount) || dspAmount < 0) {
                 return showModal("Nominal DSP tidak valid.", false, "Validasi Error");
            }

            const sppSettings = {};
            let isValid = true;
            ALL_GRADES.forEach(grade => {
                const inputId = `spp-${grade}`;
                const amount = parseInt(form.elements[inputId].value);
                if (isNaN(amount) || amount < 0) {
                    isValid = false;
                }
                sppSettings[grade] = amount;
            });
            
            if (!isValid) {
                 return showModal("Pastikan semua nominal SPP per kelas valid (angka positif).", false, "Validasi Error");
            }

            const paymentData = {
                dsp: dspAmount,
                spp: sppSettings
            };
            
            const configDocRef = getDocPath('app_config', 'settings');
            if (!configDocRef) return showModal("Sistem Firebase belum siap.");

            try {
                // Update hanya bagian 'payment' dari dokumen settings
                await setDoc(configDocRef, { 
                    payment: paymentData 
                }, { merge: true });

                showModal("Pengaturan pembayaran berhasil disimpan! Dashboard akan diperbarui.", false, "Sukses");
            } catch (error) {
                console.error("Error saving payment settings:", error);
                showModal("Gagal menyimpan pengaturan pembayaran: " + error.message, false, "Error");
            }
        }

        // --- LAPORAN ---
        function renderReportPage(container) {
            // 1. Tentukan Tahun Ajaran dan Bulan Wajib Bayar
            const academicMonths = getAcademicMonths();
            const academicYearString = `${academicMonths[0].year}/${academicMonths[11].year}`;
            
            // 2. Sortir Siswa berdasarkan Kelas
            const sortedStudents = sortStudents([...studentsData]);

            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Laporan Tunggakan Siswa</h1>
                
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700">Ringkasan Tunggakan</h2>
                    <p class="text-gray-700">Total Siswa: <span class="font-bold">${summaryData.totalStudents}</span></p>
                    <p class="text-gray-700 mb-2">Total Tunggakan Kumulatif: <span class="font-bold text-red-600">${formatCurrency(summaryData.totalDue)}</span></p>
                    <p class="text-sm text-gray-500">Perhitungan SPP didasarkan pada Tahun Ajaran: 
                        <span class="font-bold text-indigo-500">${academicMonths[0].month} ${academicMonths[0].year} - ${academicMonths[11].month} ${academicMonths[11].year} (${academicYearString})</span>
                    </p>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIS</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Wajib Bayar / Bln</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Dibayar</th>
                                <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Detail & Tunggakan</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${sortedStudents.map(s => { // Menggunakan sortedStudents
                                // ------------------------------------
                                // 1. TUNGGAKAN SPP (Berdasarkan Bulan)
                                // ------------------------------------
                                
                                // Total amount paid for SPP
                                const paidAmountSPP = transactionsData
                                    .filter(t => t.studentId === s.id && t.type === 'SPP' && t.monthPaid)
                                    .reduce((sum, t) => sum + t.amount, 0);
                                    
                                const studentSPP = getStudentSPP(s.id, s.grade);
                                const requiredAmountSPP = studentSPP * MAX_MONTHS; // Always 12 months required
                                
                                // Calculate paid months count (as integer)
                                const paidMonthsCount = studentSPP > 0 ? Math.round(paidAmountSPP / studentSPP) : 0;
                                
                                const dueMonthsCount = Math.max(0, MAX_MONTHS - paidMonthsCount);
                                const dueAmountSPP = dueMonthsCount * studentSPP;

                                // Identifikasi nama bulan yang tertunggak (asumsi: yang tertunggak adalah yang paling awal di tahun ajaran)
                                const dueMonthsList = academicMonths.slice(0, dueMonthsCount)
                                    .map(rm => rm.month); 
                                const dueMonthsDisplay = dueMonthsList.join(', ');
                                
                                // ------------------------------------
                                // 2. TUNGGAKAN DSP (Berdasarkan Saldo)
                                // ------------------------------------
                                const paidAmountDSP = transactionsData
                                    .filter(t => t.studentId === s.id && t.type === 'DSP')
                                    .reduce((sum, t) => sum + t.amount, 0);
                                    
                                const studentDSP = getStudentDSP(s.id);
                                const dueAmountDSP = Math.max(0, studentDSP - paidAmountDSP);

                                // ------------------------------------
                                // 3. TOTAL
                                // ------------------------------------
                                const totalDue = dueAmountSPP + dueAmountDSP;
                                const dueClass = totalDue > 0 ? 'text-red-600 font-bold' : 'text-green-600';
                                const baseSpp = (s.grade && appConfig.payment.spp[s.grade]) ? appConfig.payment.spp[s.grade] : SPP_PER_MONTH; 
                                const isRMP = studentSPP < baseSpp;
                                
                                // Tampilkan total dibayar SPP + DSP 
                                const totalPaidCombined = paidAmountSPP + paidAmountDSP;


                                return `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="py-3 px-4 text-sm text-gray-700">${s.nis}</td>
                                        <td class="py-3 px-4 font-medium text-gray-900">${s.name} ${isRMP ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">RMP</span>' : ''}</td>
                                        <td class="py-3 px-4 text-sm text-gray-700">${s.grade}</td>
                                        <td class="py-3 px-4 text-sm text-gray-700">SPP: ${formatCurrency(studentSPP)} <br/> DSP: ${formatCurrency(studentDSP)}</td>
                                        <td class="py-3 px-4 text-sm text-green-700">${formatCurrency(totalPaidCombined)}</td>
                                        <td class="py-3 px-4 text-sm ${dueClass}">
                                            <span class="font-semibold text-base">Total: ${formatCurrency(totalDue)}</span><br/>
                                            <span class="text-xs text-gray-500 mt-1 block">SPP (${dueMonthsCount} Bln / ${formatCurrency(dueAmountSPP)}): ${dueMonthsCount > 0 ? dueMonthsDisplay : 'Lunas'}</span>
                                            <span class="text-xs text-gray-500">DSP: ${formatCurrency(dueAmountDSP)}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // --- INIT APP ---
        window.onload = function() {
            initFirebase();
            updateClock();
            setInterval(updateClock, 1000);
            setupEventListeners();
            renderSidebar(); // Panggil pertama kali untuk mengisi sidebar
            
            // Tambahkan listener untuk input pembayaran DSP
            const dspForm = document.getElementById('dsp-form');
            if (dspForm) {
                 dspForm.addEventListener('submit', handleDSPPaymentSubmit);
            }
            const amountPaidDsp = document.getElementById('amount-paid-dsp');
            if (amountPaidDsp) {
                 amountPaidDsp.addEventListener('input', updateDSPCalculation);
            }
        };
    </script>
</body>
</html>
